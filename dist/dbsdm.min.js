var DBSDM=DBSDM||{};DBSDM.Canvas=function(){function Canvas(){this.id=ns.Random.string(5),this._container=null,this.svg=null,this.snap=!1,this._grid=null,this._offset={x:0,y:0},this._zoom=1,this._namesShown=!1,this._notesShown=!0,this._dataRef="",this.Mouse=null,this.Layout=new ns.Layout,this.History=new ns.History,this.menu={},this._entities=[],this._notes=[],this._relations=[],this.inCorrectionMode=!1}var ns=DBSDM;return Canvas.prototype.create=function(parent){var defs,gs,pattern,that;ns.Diagram.registerCanvas(this),this._container=document.createElement("div"),this._container.className="dbsdmCanvas",this.ui=new ns.UI(this._container,this),this.svg=this._container.appendChild(ns.Element.el("svg")),parent&&parent instanceof Node?parent.appendChild(this._container):document.currentScript?document.currentScript.parentNode.insertBefore(this._container,document.currentScript):document.body.appendChild(this._container),this.Mouse=new ns.Mouse(this),defs=this.svg.appendChild(ns.Element.el("defs")),gs=ns.Consts.CanvasGridSize,pattern=ns.Element.el("pattern",{id:this._sharedElementName("grid"),x:0,y:0,width:gs,height:gs,_patternUnits:"userSpaceOnUse",_patternContentUnits:"userSpaceOnUse"}),pattern.appendChild(ns.Element.el("line",{x1:.5,y1:.5,x2:gs+.5,y2:.5,stroke:"#f2f2f2"})),pattern.appendChild(ns.Element.el("line",{x1:.5,y1:.5,x2:.5,y2:gs+.5,stroke:"#f2f2f2"})),defs.appendChild(pattern),that=this,this.svg.addEventListener("mousedown",function(e){that.Mouse.down(e,that)}),this.svg.addEventListener("mousemove",function(e){that.Mouse.move(e)}),this.svg.addEventListener("mouseup",function(e){that.Mouse.up(e)}),this.svg.addEventListener("contextmenu",function(e){return that.inCorrectionMode?void e.preventDefault():(that.ui.acceptTutorialAction("Menu"),ns.Menu.hasAttachedHandlers()||ns.Menu.attach(that,"canvas"),ns.Menu.show(e),void that.Mouse.update(e))}),this.svg.addEventListener("dragover",function(e){e.preventDefault()}),this.svg.addEventListener("drop",function(e){ns.File.upload(e,that)},!1),this.ui.advanceTutorial()},Canvas.prototype._sharedElementName=function(name){return this.id+"."+name},Canvas.prototype.hasSharedHTMLElement=function(name){return null!=document.getElementById(this._sharedElementName(name))},Canvas.prototype.createSharedHTMLElement=function(id,element){element.id=this.id+"."+id,this._container.appendChild(element)},Canvas.prototype.getSharedHTMLElement=function(name){return this.hasSharedHTMLElement(name)?document.getElementById(this._sharedElementName(name)):null},Canvas.prototype.setMode=function(mode){this.svg.classList.add(mode+"Mode")},Canvas.prototype.unsetMode=function(mode){this.svg.classList.remove(mode+"Mode")},Canvas.prototype.isInMode=function(mode){return this.svg.classList.contains(mode+"Mode")},Canvas.prototype._switchSnap=function(){this.snap=!this.snap,this.snap?(this._grid=ns.Element.el("rect",{x:this._offset.x,y:this._offset.y,width:"100%",height:"100%",fill:"url(#"+this._sharedElementName("grid")+")"}),this.svg.insertBefore(this._grid,this.svg.firstChild)):(this.svg.removeChild(this._grid),this._grid=null)},Canvas.prototype.updateViewbox=function(){var rect=this.svg.getBoundingClientRect(),width=rect.width,height=rect.height,x=this._offset.x,y=this._offset.y,w=width/this._zoom,h=height/this._zoom;ns.Element.attr(this.svg,{_viewBox:x+" "+y+" "+w+" "+h}),this._grid&&ns.Element.attr(this._grid,{x:x,y:y})},Canvas.prototype._scroll=function(rx,ry){this._offset.x-=rx,this._offset.y-=ry,this.updateViewbox(),this.ui.acceptTutorialAction("Scroll")},Canvas.prototype.resetView=function(){this._offset.x=0,this._offset.y=0,this.updateViewbox()},Canvas.prototype.getZoomLevel=function(){return this._zoom},Canvas.prototype.zoomIn=function(){this._zoom=Math.min(2,this._zoom+.1),this.updateViewbox(),this.ui.updateZoomLevels(this._zoom)},Canvas.prototype.zoomOut=function(){this._zoom=Math.max(.1,this._zoom-.1),this.updateViewbox(),this.ui.updateZoomLevels(this._zoom)},Canvas.prototype.zoomReset=function(){this._zoom=1,this.updateViewbox(),this.ui.updateZoomLevels(this._zoom)},Canvas.prototype.fullscreen=function(){ns.Fullscreen.enabled()&&ns.Fullscreen.toggle(this._container,this)},Canvas.prototype._createNote=function(){if(this.inCorrectionMode||!ns.Diagram.allowEdit)return null;var note=new ns.Control.Note(this,new ns.Model.Note);note.create()},Canvas.prototype.addNote=function(note){this._notesShown||this._toggleNotes(),this._notes.push(note)},Canvas.prototype.removeNote=function(note){for(var i=0;i<this._notes.length;i++)if(this._notes[i]==note)return void this._notes.splice(i,1)},Canvas.prototype._toggleNotes=function(){for(var i=0;i<this._notes.length;i++)this._notesShown?this._notes[i].hide():this._notes[i].show();this._notesShown=!this._notesShown},Canvas.prototype._createEntity=function(){if(this.inCorrectionMode||!ns.Diagram.allowEdit)return null;var ent=new ns.Control.Entity(this,new ns.Model.Entity("Entity_"+(this._entities.length+1)));return ent.create(),ent},Canvas.prototype._createDefaultEntity=function(){var entity=this._createEntity();entity&&(entity.place({x:this.Mouse.x,y:this.Mouse.y,dx:ns.Consts.EntityDefaultWidth,dy:ns.Consts.EntityDefaultHeight}),entity.finish())},Canvas.prototype.addEntity=function(entity){this._entities.push(entity)},Canvas.prototype.removeEntity=function(entity){for(var i=0;i<this._entities.length;i++)if(this._entities[i]==entity)return void this._entities.splice(i,1)},Canvas.prototype.addRelation=function(relation){this._relations.indexOf(relation)===-1&&this._relations.push(relation)},Canvas.prototype.removeRelation=function(relation){for(var i=0;i<this._relations.length;i++)if(this._relations[i]==relation)return void this._relations.splice(i,1)},Canvas.prototype._toggleRelationNames=function(){for(var i=0;i<this._relations.length;i++)this._namesShown?this._relations[i].hideNames():this._relations[i].showNames();this._namesShown=!this._namesShown},Canvas.prototype.clear=function(){for(;0!=this._entities.length;)this._entities[0].delete();for(;0!=this._notes.length;)this._notes[0].delete()},Canvas.prototype.sort=function(){this.Layout.sort([].concat(this._entities,this._notes),this._relations)},Canvas.prototype._sortAttributes=function(a,b){var cmp=b.primary-a.primary;return 0!=cmp?cmp:(cmp=b.unique-a.unique,0!=cmp?cmp:(cmp=a.nullable-b.nullable,0!=cmp?cmp:cmp=a.name.localeCompare(b.name)))},Canvas.prototype._sortEntities=function(a,b){return a.name.localeCompare(b.name)},Canvas.prototype._sortRelationLegs=function(a,b){return JSON.stringify(a).localeCompare(JSON.stringify(b).entity)},Canvas.prototype._sortRelations=function(a,b){return JSON.stringify(a).localeCompare(JSON.stringify(b))},Canvas.prototype._sortData=function(data,sortAttributes){var count,i;if(sortAttributes)for(count=data.entities.length,i=0;i<count;i++)data.entities[i].attr.sort(this._sortAttributes);for(data.entities.sort(this._sortEntities),count=data.relations.length,i=0;i<count;i++)data.relations[i].sort(this._sortRelationLegs);data.relations.sort(this._sortRelations)},Canvas.prototype.export=function(promptDownload,prettify,saveRef,properties,filename){function getExportData(list,flatten){var i,data,count=list.length,a=[];for(i=0;i<count;i++)data=list[i].getModel().getExportData(properties),flatten?a=a.concat(data):a.push(data);return a}var result,jsonData;return properties={saveNotes:!(!properties||"boolean"!=typeof properties.saveNotes)&&properties.saveNotes,saveRelationNames:!(!properties||"boolean"!=typeof properties.saveRelationNames)&&properties.saveRelationNames,saveTransform:!(!properties||"boolean"!=typeof properties.saveTransform)&&properties.saveTransform,sortAttributes:!properties||"boolean"!=typeof properties.sortAttributes||properties.sortAttributes},result={},result.entities=getExportData(this._entities,!0),result.relations=getExportData(this._relations),properties.saveNotes&&(result.notes=getExportData(this._notes)),this._sortData(result,properties.sortAttributes),jsonData=prettify?JSON.stringify(result,null,2):JSON.stringify(result),saveRef!==!1&&(saveRef||ns.Diagram.confirmLeave)&&(this._dataRef=this._generateRef()),ns.Diagram.allowFile&&promptDownload&&ns.File.download(jsonData,filename||"model.json","application/json"),jsonData},Canvas.prototype.import=function(data,forceSort){function makeXor(xorId,legControl,entityControl){xorId&&(xorMap[xorId]?entityControl.xorWith(xorMap[xorId],legControl):xorMap[xorId]=legControl)}var i,control,model,entityControlsMap,sort,entity,parent,list,perRow,r,c,xorMap,relation,sourceEntityControl,targetEntityControl;for(this.History.begin(),this.clear(),this.History.pause(),forceSort&&this._sortData(data),entityControlsMap={},i=0;i<data.entities.length;i++)model=new ns.Model.Entity(data.entities[i]),entityControlsMap[model.getName()]=new ns.Control.Entity(this,model).import();for(sort=!1,i=0;i<data.entities.length;i++)entity=data.entities[i].name,parent=data.entities[i].parent,parent&&entityControlsMap[entity].importIsa(entityControlsMap[parent]),!forceSort&&data.entities[i].transform||(entityControlsMap[entity].fitToContents(),sort=!0);if(data.notes)for(i=0;i<data.notes.length;i++)model=new ns.Model.Note,model.import(data.notes[i]),new ns.Control.Note(this,model).import();for((forceSort||sort)&&(list=[].concat(this._entities,this._notes),perRow=Math.ceil(Math.sqrt(list.count)),r=0,c=0,list.forEach(function(control){control._model.setPosition(200*c,150*r),control._view.redraw(),++c==perRow&&(r++,c=0)})),xorMap={},i=0;i<data.relations.length;i++)this._namesShown||!data.relations[i][0].name&&!data.relations[i][1].name||(this._namesShown=!0),model=new ns.Model.Relation((new ns.Model.RelationLeg).import(data.relations[i][0]),(new ns.Model.RelationLeg).import(data.relations[i][1])),relation=data.relations[i],sourceEntityControl=entityControlsMap[relation[0].entity],targetEntityControl=entityControlsMap[relation[1].entity],control=new ns.Control.Relation(this,sourceEntityControl,targetEntityControl,null,null,model),control.import(forceSort||!relation[0].transform||!relation[1].transform),makeXor(relation[0].xor,control._legs.source,sourceEntityControl),makeXor(relation[1].xor,control._legs.target,targetEntityControl);(forceSort||sort)&&this.sort(),ns.Diagram.confirmLeave&&(this._dataRef=this._generateRef()),this.History.resume(),this.History.record(this,"import",null,[data,forceSort]),this.History.commit()},Canvas.prototype._generateRef=function(){return JSON.stringify(this.export(!1,!1,!1,{saveNotes:!0,saveRelationNames:!0}))},Canvas.prototype.didDataChange=function(){return this._generateRef()!==this._dataRef},Canvas.prototype.saveAsImage=function(){var cloneDefs=ns.Diagram._defs.cloneNode(!0);this.svg.insertBefore(cloneDefs,this.svg.firstChild),saveSvgAsPng(this.svg,"diagram.png",{left:this._offset.x,top:this._offset.y,selectorRemap:function(selector){return selector=selector.replace(/^div\.dbsdmCanvas > svg(\W|$)/,"svg"),selector=selector.replace(/^div\.dbsdmCanvas\s/,"")}}),cloneDefs.remove()},Canvas.prototype._loadLocal=function(key){ns.Diagram.allowRecent&&this.import(JSON.parse(localStorage.getItem(key)))},Canvas.prototype.saveLocal=function(suffix){if(ns.Diagram.allowRecent){var name=ns.Consts.LocalStoragePrefix+(new Date).toISOString();suffix&&(name+=" - "+suffix),localStorage.setItem(name,this.export(!1,!1,!1,{saveNotes:!0,saveRelationNames:!0,saveTransform:!0,sortAttributes:!1})),ns.Menu.build()}},Canvas.prototype.onMouseDown=function(e,mouse){if(0==mouse.button){var entity=this._createEntity();entity&&this.Mouse.attachObject(entity)}},Canvas.prototype.onMouseMove=function(e,mouse){1==mouse.button&&this._scroll(mouse.rx,mouse.ry)},Canvas.prototype.handleMenu=function(action){switch(action){case"new-entity":this._createDefaultEntity();break;case"new-note":this._createNote();break;case"toggle-rel-names":this._toggleRelationNames();break;case"toggle-notes":this._toggleNotes();break;case"snap":this._switchSnap();break;case"zoom-in":this.zoomIn();break;case"zoom-reset":this.zoomReset();break;case"zoom-out":this.zoomOut();break;case"reset-view":this.resetView();break;case"save-model":this.export(!0,!0,null,{saveNotes:!0,saveRelationNames:!0,saveTransform:!0,sortAttributes:!1},"model.json");break;case"save-data":this.export(!0,!0,null,{saveNotes:!0},"data.json");break;case"save-image":this.saveAsImage();break;case"fullscreen":this.fullscreen();break;case"clear":(0!=this._entities.length||0!=this._notes.length)&&ns.Diagram.allowEdit&&window.confirm("Are you sure you want to clear the model?")&&(this.saveLocal(),this.clear());break;case"clear-local":ns.Diagram.allowRecent&&ns.Diagram.clearLocal();break;case"undo":this.History.undo();break;case"redo":this.History.redo()}/^local#(.+)/.test(action)&&this._loadLocal(action.split("#")[1])},Canvas.prototype.getMenuState=function(){return{"toggle-rel-names":this._namesShown,"toggle-notes":this._notesShown,undo:this.History.hasUndo(),redo:this.History.hasRedo()}},Canvas.prototype.playback=function(action,from,to){switch(action){case"import":to?this.import(to[0],to[1]):this.clear()}},Canvas}(),DBSDM.Consts={DoubleClickInterval:500,SnappingLimit:5,CanvasGridSize:15,EntityDefaultWidth:90,EntityDefaultHeight:70,EntityAttributesOffset:20,EntityStrokeWidth:1,EntityPadding:10,EntityEdgePadding:10,EntityExtraHeight:5,NoteDefaultWidth:150,NoteDefaultHeight:100,NoteStrokeWidth:1,NotePadding:5,DefaultAnchorOffset:11,MinAnchorAnchorDistance:10,ArcSize:12,ArcEndPointOffset:10,ArcEdgeDistance:17,ArcArcDistance:10,UIMessageTransition:.4,UIDefaultSuccessDuration:2,UIDefaultErrorDuration:2,LocalStoragePrefix:"DBSDM_"},DBSDM.Diagram=function(){var ns=DBSDM,self={};return self.allowEdit=!0,self.allowFile=!0,self.allowCorrectMode=!1,self.allowRecent=!0,self.showTutorial=!0,self.confirmLeave=!1,self._canvasList=[],self.lastCanvas=null,self.cancelAction=null,self.init=function(options){options=options||{},"boolean"==typeof options.allowEdit&&(self.allowEdit=options.allowEdit),"boolean"==typeof options.allowFile&&(self.allowFile=options.allowFile),"boolean"==typeof options.allowCorrectMode&&(self.allowCorrectMode=options.allowCorrectMode),"boolean"==typeof options.allowRecent&&(self.allowRecent=options.allowRecent),"boolean"==typeof options.showTutorial&&(self.showTutorial=options.showTutorial),"boolean"==typeof options.confirmLeave&&(self.confirmLeave=options.confirmLeave),ns.Menu.build();var svg=document.body.appendChild(ns.Element.el("svg",{id:"dbsdmShared"}));this._defs=svg.appendChild(ns.Element.el("defs")),this._createEntityElements(),this._createAttributeElements(),this._createRelationElements(),this._createRelationLegElements(),window.onbeforeunload=function(e){if(self.allowRecent&&self.saveLocal(),self.confirmLeave&&self.didAnyCanvasChange()){var dialog="Are you sure you want to leave? Your model may not have been saved.";return e.returnValue=dialog,dialog}},window.addEventListener("keydown",function(e){if(self.lastCanvas)switch(e.keyCode){case 112:return self.lastCanvas.ui.toggleHelp(),void e.preventDefault();case 90:return void(e.ctrlKey&&(e.shiftKey?self.lastCanvas.History.redo():self.lastCanvas.History.undo()))}27==e.keyCode&&self.cancelAction?(self.cancelAction(),self.cancelAction=null):ns.Control.CanvasObject.active&&ns.Control.CanvasObject.active.onKeyPress(e)}),window.addEventListener("keypress",function(e){if(self.lastCanvas)switch(e.key){case"+":return void self.lastCanvas.zoomIn();case"-":return void self.lastCanvas.zoomOut();case"*":return void self.lastCanvas.zoomReset()}}),window.addEventListener("mousedown",function(e){ns.Menu.hide(),ns.Control.CanvasObject.active&&ns.Control.CanvasObject.active.deactivate()}),ns.Fullscreen.setEvents(function(e){var el=ns.Fullscreen.fullscreenElement();el?el.classList.add("fullscreen"):document.querySelector(".fullscreen").classList.remove("fullscreen"),ns.Fullscreen.lastCanvas&&ns.Fullscreen.lastCanvas.updateViewbox()})},self.registerCanvas=function(canvas){self._canvasList.push(canvas)},self.didAnyCanvasChange=function(){var i,changed=!1,count=self._canvasList.length;for(i=0;i<count;i++)self._canvasList[i].didDataChange()&&(self._canvasList[i].ui.error("Changes in this model have not been saved"),changed=!0);return changed},self.saveLocal=function(){var i,suffix,count=self._canvasList.length;for(i=0;i<count;i++)self._canvasList[i].didDataChange()&&(suffix=count>1?"Canvas "+(i+1):null,self._canvasList[i].saveLocal(suffix))},self.clearLocal=function(){var i,key,prefix=ns.Consts.LocalStoragePrefix;for(i=0;i<localStorage.length;i++)key=localStorage.key(i),new RegExp("^"+prefix).test(key)&&localStorage.removeItem(key);ns.Menu.build()},self._sharedElementName=function(name){return name},self.hasSharedElement=function(name){return null!=document.getElementById(this._sharedElementName(name))},self.createSharedElement=function(name,element){ns.Element.attr(element,{id:this._sharedElementName(name)}),this._defs.appendChild(element)},self.getSharedElement=function(name,attrs){return this.hasSharedElement(name)?ns.Element.use(this._sharedElementName(name),attrs):null},self.getSharedElementId=function(name){return this.hasSharedElement(name)?"#"+this._sharedElementName(name):null},self._createEntityElements=function(){self.createSharedElement("Entity.Bg",ns.Element.rect(0,0,"100%","100%",{rx:10,ry:10,fill:"#A4E1FF",stroke:"#0000FF",strokeWidth:ns.Consts.EntityStrokeWidth})),self.createSharedElement("Entity.Bg.Selected",ns.Element.rect(0,0,"100%","100%",{rx:10,ry:10,fill:"#EFFFA4",stroke:"#ffa800",strokeWidth:ns.Consts.EntityStrokeWidth})),self.createSharedElement("Entity.Bg.Incorrect",ns.Element.rect(0,0,"100%","100%",{rx:10,ry:10,fill:"#ffaaaa",stroke:"#b62727",strokeWidth:ns.Consts.EntityStrokeWidth})),self.createSharedElement("Note.Bg",ns.Element.rect(0,0,"100%","100%",{fill:"#fffbb4",stroke:"#f9de4f",strokeWidth:ns.Consts.NoteStrokeWidth})),self.createSharedElement("Note.Bg.Incorrect",ns.Element.rect(0,0,"100%","100%",{fill:"#ffaaaa",stroke:"#b62727",strokeWidth:ns.Consts.NoteStrokeWidth})),self.createSharedElement("Entity.ControlRectangle",ns.Element.rect(0,0,"100%","100%",{fill:"none",strokeWidth:1,shapeRendering:"crispEdges",pointerEvents:"none",stroke:"black"})),self.createSharedElement("Entity.ControlPoint",ns.Element.rect(0,0,8,8,{fill:"none",strokeWidth:1,stroke:"black",shapeRendering:"crispEdges",transform:"translate(-4,-4)",pointerEvents:"all"}))},self._createRelationElements=function(){self.createSharedElement("Relation.MiddlePoint",ns.Element.rect(0,0,6,6,{fill:"black",strokeWidth:1,stroke:"black",shapeRendering:"crispEdges",transform:"translate(-3,-3)",pointerEvents:"visible"}))},self._createRelationLegElements=function(){ns.Diagram.createSharedElement("Relation.AnchorControl",ns.Element.rect(-9.5,-14.5,18,15,{fill:"none",stroke:"none"})),ns.Diagram.createSharedElement("Relation.AnchorMany",ns.Element.el("polyline",{points:"-4.5,-0.5, -0.5,-10.5, 0.5,-10.5, 4.5,-0.5",fill:"none",stroke:"black",strokeWidth:1})),ns.Diagram.createSharedElement("Relation.AnchorIdentifying",ns.Element.el("polyline",{points:"-5.5,-10.5, 5.5,-10.5",fill:"none",stroke:"black",strokeWidth:1})),ns.Diagram.createSharedElement("Relation.CP",ns.Element.rect(0,0,6,6,{fill:"none",strokeWidth:1,stroke:"black",shapeRendering:"crispEdges",transform:"translate(-3,-3)"}))},self._createAttributeElements=function(){var gradient=ns.Element.el("linearGradient",{x1:0,y1:0,x2:0,y2:1});gradient.appendChild(ns.Element.el("stop",{"stop-color":"#ffffff",offset:"0%"})),gradient.appendChild(ns.Element.el("stop",{"stop-color":"#eaeaea",offset:"100%"})),ns.Diagram.createSharedElement("Attr.BgGradient",gradient),ns.Diagram.createSharedElement("Attr.Bg",ns.Element.rect(0,0,"100%","100%",{stroke:"#5271FF",strokeWidth:1,fill:"#eaeaea"}))},self}(),DBSDM.Element=function(){var svgNS="http://www.w3.org/2000/svg",xlinkNS="http://www.w3.org/1999/xlink",self={},create=function(element){return document.createElementNS(svgNS,element)};return self.el=function(element,attr){return self.attr(create(element),attr)},self.attr=function(node,attributes){var name,value,ns;for(name in attributes)attributes.hasOwnProperty(name)&&(value=attributes[name],name="_"==name[0]?name.substr(1):name.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase(),ns=null,"href"==name&&(ns=xlinkNS),null==value?node.removeAttributeNS(ns,name):node.setAttributeNS(ns,name,value));return node},self.addClass=function(node,className){node.classList.add(className)},self.transform=function(node,translate,rotate,scale){var tran=[];translate&&tran.push("translate("+translate.join(" ")+")"),rotate&&tran.push("rotate("+rotate.join(" ")+")"),scale&&tran.push("scale("+scale.join(" ")+")"),self.attr(node,{transform:tran.join(" ")})},self.use=function(id,attrs){return attrs=attrs||{},self.attr(create("use"),Object.assign(attrs,{href:"#"+id}))},self.rect=function(x,y,width,height,params){var attrs={x:x||0,y:y||0,width:width||"100%",height:height||"100%"};return Object.assign(attrs,params),self.attr(create("rect"),attrs)},self.g=function(){var i,node=create("g");for(i=0;i<arguments.length;i++)node.appendChild(arguments[i]);return node},self.text=function(x,y,text,attrs){var node,params={x:x||0,y:y||0};return Object.assign(params,attrs),node=self.attr(create("text"),params),text&&(node.innerHTML=text),node},self.Path=function(){function Path(){this._str=""}return Path.prototype.isEmpty=function(){return""==this._str},Path.prototype.path=function(attr){attr=attr||{};var prop=Object.assign(attr,{d:this._str});return DBSDM.Element.el("path",prop)},Path.prototype.M=function(x,y){return this._str+="M"+x+" "+y,this},Path.prototype.m=function(x,y){return this._str+="m"+x+" "+y,this},Path.prototype.H=function(x){return this._str+="H"+x,this},Path.prototype.h=function(x){return this._str+="h"+x,this},Path.prototype.V=function(x){return this._str+="V"+x,this},Path.prototype.v=function(x){return this._str+="v"+x,this},Path.prototype.L=function(x,y){return this._str+="L"+x+" "+y,this},Path.prototype.l=function(x,y){return this._str+="l"+x+" "+y,this},Path.prototype.C=function(x1,y1,x2,y2,x,y){return this._str+="C"+x1+" "+y1+","+x2+" "+y2+","+x+" "+y,this},Path.prototype.c=function(x1,y1,x2,y2,x,y){return this._str+="c"+x1+" "+y1+","+x2+" "+y2+","+x+" "+y,this},Path}(),self}(),DBSDM.Enums={Cardinality:{MANY:0,ONE:1},Edge:{TOP:0,RIGHT:1,BOTTOM:2,LEFT:3}},DBSDM.File=function(){var ns=DBSDM,self={};return self.download=function(data,filename,type){var a,file,url;ns.Diagram.allowFile&&(a=document.createElement("a"),file=new Blob([data],{type:type}),window.navigator.msSaveOrOpenBlob?window.navigator.msSaveOrOpenBlob(file,filename):(url=URL.createObjectURL(file),a.href=url,a.download=filename,document.body.appendChild(a),a.click(),setTimeout(function(){document.body.removeChild(a),window.URL.revokeObjectURL(url)},0)))},self.upload=function(e,canvas){var files,file;return e.stopPropagation(),e.preventDefault(),ns.Diagram.allowFile?(files=e.target.files||e.dataTransfer.files,void(files.length>0&&(file=files[0],"application/x-zip-compressed"==file.type||"application/zip"==file.type?self._processZip(canvas,file):"application/json"==file.type||/\.json$/.test(file.name)?self._processJson(canvas,file):(canvas.ui.error("File couldn't be imported: unsupported file type. Import either json with exported data or SQLDeveloper zip"),console.log(e))))):void canvas.ui.error("File upload is turned off")},self.loadBlob=function(canvas,blob){"application/x-zip-compressed"==blob.type||"application/zip"==blob.type?self._processZip(canvas,blob):"application/json"==blob.type?self._processJson(canvas,file):(console.log("File couldn't be imported: unsupported file type. Import either json with exported data or SQLDeveloper zip"),console.log(e))},self._processJson=function(canvas,jsonfile){var reader=new FileReader;reader.onload=function(e){var data,result=e.target.result;try{data=JSON.parse(result),canvas.import(data),canvas.ui.success("File was imported",ns.Consts.UIDefaultSuccessDuration)}catch(e){canvas.ui.error("File couldn't be parsed properly - make sure it is valid JSON file"),console.log(e)}},reader.onerror=function(e){canvas.ui.error("File couldn't be uploaded, please try again"),console.log(e)},reader.readAsText(jsonfile)},self._processZip=function(canvas,zipfile){function toArray(obj){return Object.keys(obj).map(function(key){return obj[key]})}function parseAttributes(nodeList){var i,node,id,name,nullableNode,attributeMap={};if(nodeList)for(i=0;i<nodeList.length;i++)node=nodeList[i],node.querySelector("referedAttribute")||(id=node.getAttribute("id"),name=node.getAttribute("name"),id&&name&&(nullableNode=node.querySelector("nullsAllowed"),attributeMap[id]={name:name,primary:!1,unique:!1,nullable:nullableNode&&"true"==nullableNode.innerHTML||!1}));return attributeMap}function parseKeys(nodeList,attributeMap){var i,node,attributes,atrIdsNode,refNodes,k,primary,unique,pkNode,j,id;if(nodeList)for(i=0;i<nodeList.length;i++){if(node=nodeList[i],attributes=null,atrIdsNode=node.querySelector("newElementsIDs"))attributes=atrIdsNode.innerHTML.split(",");else if(refNodes=node.querySelectorAll("usedAttributes attributeRef"))for(attributes=[],k=0;k<refNodes.length;k++)attributes.push(refNodes[k].innerHTML);if(attributes)for(primary=!1,unique=!1,pkNode=node.querySelector("pk"),pkNode&&"true"==pkNode.innerHTML?primary=!0:unique=!0,j=0;j<attributes.length;j++)id=attributes[j],attributeMap[id]&&(attributeMap[id].primary=primary,attributeMap[id].unique=unique)}}function parseEntity(node,entityMap,parentMap){var parentNode,attributeMap,id=node.getAttribute("id"),name=node.getAttribute("name");id&&name&&(entityMap[id]={name:name,parent:null,attr:null},parentNode=node.querySelector("hierarchicalParent"),parentNode&&parentMap.push([id,parentNode.innerHTML]),attributeMap=parseAttributes(node.querySelectorAll("attributes > Attribute")),parseKeys(node.querySelectorAll("identifiers > identifier"),attributeMap),entityMap[id].attr=toArray(attributeMap))}function parseRelation(node,relationsMap,relationsRef){var sourceEntityIdNode=node.querySelector("sourceEntity"),identifyingNode=node.querySelector("identifying"),optionalSourceNode=node.querySelector("optionalSource"),sourceCardinalityNode=node.querySelector("sourceCardinality"),nameOnSource=node.querySelector("nameOnSource"),targetEntityIdNode=node.querySelector("targetEntity"),optionalTargetNode=node.querySelector("optionalTarget"),targetCardinalityNode=node.querySelector("targetCardinalityString"),nameOnTarget=node.querySelector("nameOnTarget");sourceEntityIdNode&&targetEntityIdNode&&(relationsMap.push([{entity:sourceEntityIdNode.innerHTML,identifying:!1,optional:!!optionalSourceNode&&"true"==optionalSourceNode.innerHTML,cardinality:sourceCardinalityNode&&"*"==sourceCardinalityNode.innerHTML?0:1,xor:null,name:nameOnSource&&""!=nameOnSource.innerHTML?nameOnSource.innerHTML:null},{entity:targetEntityIdNode.innerHTML,identifying:!!identifyingNode&&"true"==identifyingNode.innerHTML,optional:!!optionalTargetNode&&"true"==optionalTargetNode.innerHTML,cardinality:targetCardinalityNode&&"*"==targetCardinalityNode.innerHTML?0:1,xor:null,name:nameOnTarget&&""!=nameOnTarget.innerHTML?nameOnTarget.innerHTML:null}]),relationsRef[node.getAttribute("id")]=relationsMap.length-1)}function parseArc(node,arcMap){var i,relationID,arcID=node.getAttribute("id"),entityID=node.querySelector("entity").innerHTML,relations=node.querySelectorAll("relationID");for(arcMap[arcID]=[],i=0;i<relations.length;i++)relationID=relations[i].innerHTML,arcMap[arcID].push([entityID,relationID])}function parseNote(node,bounds){var transform,div,defaultHeight,resultText,skipSpace,text=node.querySelector("comment").textContent;return text=text.replace(/<br\s*\/?>/i,"\n"),transform={x:parseInt(bounds.getAttribute("x")),y:parseInt(bounds.getAttribute("y")),width:parseInt(bounds.getAttribute("width"))-2*ns.Consts.NoteStrokeWidth,height:parseInt(bounds.getAttribute("height")-2*ns.Consts.NoteStrokeWidth)},div=document.createElement("div"),div.classList.add("note-content-helper"),div.style.width=transform.width-2*ns.Consts.NotePadding+"px",document.body.appendChild(div),div.textContent="&nbsp;",defaultHeight=div.getBoundingClientRect().height,resultText="",div.textContent="",skipSpace=!1,text.trim().split(/\n/).forEach(function(line){var prevHeight=defaultHeight;line.split(/\s+/).forEach(function(word){div.textContent+=" "+word;var currentHeight=div.getBoundingClientRect().height;currentHeight>prevHeight?resultText+="\n":skipSpace||(resultText+=" "),resultText+=word,prevHeight=currentHeight,skipSpace=!1}),div.textContent+="\n",resultText+="\n",skipSpace=!0,prevHeight=div.getBoundingClientRect().height}),document.body.removeChild(div),{text:resultText.trim(),transform:transform}}function parseTransforms(node,map){function computeEdge(anchor,entity){return anchor.x<entity.x+1?ns.Enums.Edge.LEFT:anchor.x>entity.x+entity.width-1?ns.Enums.Edge.RIGHT:anchor.y<entity.y+1?ns.Enums.Edge.TOP:ns.Enums.Edge.BOTTOM}var vid,notes,objects,i,id,bounds,type,connectors,pointNodes,points,j,point,transform,p,last,vidSource,vidTarget;for(map.entities={},map.relations={},vid={},notes=[],objects=node.querySelectorAll("OView"),i=0;i<objects.length;i++)id=objects[i].getAttribute("oid"),bounds=objects[i].querySelector("bounds"),type=objects[i].getAttribute("otype"),"Entity"==type?(map.entities[id]={x:parseInt(bounds.getAttribute("x")),y:parseInt(bounds.getAttribute("y")),width:parseInt(bounds.getAttribute("width")),height:parseInt(bounds.getAttribute("height"))},vid[objects[i].getAttribute("vid")]=id):"Note"==type&&notes.push(parseNote(objects[i],bounds));for(connectors=node.querySelectorAll("Connector"),i=0;i<connectors.length;i++)if(pointNodes=connectors[i].querySelectorAll("point"),0!=pointNodes.length){for(id=connectors[i].getAttribute("oid"),points=[],j=0;j<pointNodes.length;j++)point=pointNodes[j],points.push({x:parseInt(point.getAttribute("x")),y:parseInt(point.getAttribute("y"))});for(2==points.length&&points.splice(1,0,{x:.5*(points[0].x+points[1].x),y:.5*(points[0].y+points[1].y)}),transform=[{},{}],transform[0]={anchor:{x:points[0].x,y:points[0].y,edge:null},points:[],manual:!0},p=1;p<points.length-1;p++)transform[0].points.push({x:points[p].x,y:points[p].y});last=points.length-1,transform[1]={anchor:{x:points[last].x,y:points[last].y,edge:null},points:[{x:points[last-1].x,y:points[last-1].y}],manual:!0},vidSource=connectors[i].getAttribute("vid_source"),transform[0].anchor.edge=computeEdge(transform[0].anchor,map.entities[vid[vidSource]]),vidTarget=connectors[i].getAttribute("vid_target"),transform[1].anchor.edge=computeEdge(transform[1].anchor,map.entities[vid[vidTarget]]),map.relations[id]=transform}return notes}var zip=new JSZip;zip.loadAsync(zipfile).then(function(contents){var i,toPromise=[],files=zip.file(/(\W|^)logical\/((entity|relation|arc)\/seg_0|subviews)\/.*?\.xml$/);for(i=0;i<files.length;i++)toPromise.push(files[i].async("string"));Promise.all(toPromise).then(function(result){var i,xml,entity,parent,arcID,entityID,relationID,relIndex,rel,entID,relID,ref,source,target,data,entityMap={},parentMap=[],relationsMap=[],relationsRef={},arcMap={},transformsMap={},notes=[],parser=new DOMParser;for(i=0;i<result.length;i++)switch(xml=parser.parseFromString(result[i],"application/xml"),xml.documentElement.nodeName){case"Entity":parseEntity(xml.documentElement,entityMap,parentMap);break;case"Relation":parseRelation(xml.documentElement,relationsMap,relationsRef);break;case"Arc":parseArc(xml.documentElement,arcMap);break;case"Diagram":notes=parseTransforms(xml.documentElement,transformsMap)}for(i=0;i<parentMap.length;i++)entity=parentMap[i][0],parent=parentMap[i][1],entityMap[entity]&&entityMap[parent]&&(entityMap[entity].parent=entityMap[parent].name);for(arcID in arcMap)if(arcMap.hasOwnProperty(arcID))for(i=0;i<arcMap[arcID].length;i++)entityID=arcMap[arcID][i][0],relationID=arcMap[arcID][i][1],relIndex=relationsRef[relationID],rel=relationsMap[relIndex],rel[0].entity==entityID?rel[0].xor=arcID:rel[1].entity==entityID&&(rel[1].xor=arcID);
for(entID in transformsMap.entities)transformsMap.entities.hasOwnProperty(entID)&&entityMap.hasOwnProperty(entID)&&(entityMap[entID].transform=transformsMap.entities[entID]);for(relID in transformsMap.relations)transformsMap.relations.hasOwnProperty(relID)&&relationsRef.hasOwnProperty(relID)&&(ref=relationsRef[relID],relationsMap[ref][0].transform=transformsMap.relations[relID][0],relationsMap[ref][1].transform=transformsMap.relations[relID][1]);for(i=0;i<relationsMap.length;i++)source=relationsMap[i][0].entity,target=relationsMap[i][1].entity,relationsMap[i][0].entity=entityMap[source].name,relationsMap[i][1].entity=entityMap[target].name;data={entities:toArray(entityMap),relations:relationsMap,notes:notes};try{canvas.import(data),canvas.ui.success("File was imported",ns.Consts.UIDefaultSuccessDuration)}catch(e){canvas.ui.error("File couldn't be imported: check you are importing zip with exported SQL Developer model"),console.log(e)}})})},self}(),DBSDM.Fullscreen=function(){var self={};return self.lastCanvas=null,self.inFullscreen=function(){return null!=self.fullscreenElement()},self.enabled=function(){return"fullscreenEnabled"in document?document.fullscreeEnabled:"webkitFullscreenEnabled"in document?document.webkitFullscreenEnabled:"mozFullScreenEnabled"in document?document.mozFullScreenEnabled:"msFullscreenEnabled"in document&&document.msFullscreenEnabled},self.fullscreenElement=function(){return"fullscreenElement"in document?document.fullscreenElement:"webkitFullscreenElement"in document?document.webkitFullscreenElement:"mozFullScreenElement"in document?document.mozFullScreenElement:"msFullscreenElement"in document?document.msFullscreenElement:null},self.request=function(element){"requestFullscreen"in element&&element.requestFullscreen(),"webkitRequestFullscreen"in element&&element.webkitRequestFullscreen(),"mozRequestFullScreen"in element&&element.mozRequestFullScreen(),"msRequestFullscreen"in element&&element.msRequestFullscreen()},self.exit=function(){"exitFullscreen"in document&&document.exitFullscreen(),"webkitExitFullscreen"in document&&document.webkitExitFullscreen(),"mozCancelFullScreen"in document&&document.mozCancelFullScreen(),"msExitFullscreen"in document&&document.msExitFullscreen()},self.toggle=function(element,canvas){self.lastCanvas=canvas,self.fullscreenElement()!=element?self.request(element):self.exit()},self.setEvents=function(onchange,onerror){"onfullscreenchange"in document&&(onchange&&(document.onfullscreenchange=onchange),onerror&&(document.onfullscreenerror=onerror)),"onwebkitfullscreenchange"in document&&(onchange&&(document.onwebkitfullscreenchange=onchange),onerror&&(document.onwebkitfullscreenerror=onerror)),"onmozfullscreenchange"in document&&(onchange&&(document.onmozfullscreenchange=onchange),onerror&&(document.onmozfullscreenerror=onerror)),"onmsfullscreenchange"in document&&(onchange&&(document.onmsfullscreenchange=onchange),onerror&&(document.onmsfullscreenerror=onerror))},self}(),DBSDM.Geometry=function(){var self={};return self.pointToPointDistance=function(A,B){var x=B.x-A.x,y=B.y-A.y;return Math.sqrt(x*x+y*y)},self.pointToPointSquareDistance=function(A,B){var x=B.x-A.x,y=B.y-A.y;return x*x+y*y},self.pointToLineDistance=function(p,P1,P2){var a=P2.y-P1.y,b=P2.x-P1.x,c=P2.x*P1.y-P2.y*P1.x,y=P2.y-P1.y,x=P2.x-P1.x;return Math.abs(a*p.x-b*p.y+c)/Math.sqrt(y*y+x*x)},self.isBetween=function(x,a,b,offset){return b<a?b-offset<=x&&x<=a+offset:a-offset<=x&&x<=b+offset},self.pointIsInBox=function(P,A,B,offset){return self.isBetween(P.x,A.x,B.x,offset)&&self.isBetween(P.y,A.y,B.y,offset)},self.snap=function(coor,snapA,snapB,limit){var dA,dB;if(snapB=snapB||snapA,dA=Math.abs(coor-snapA),dB=Math.abs(coor-snapB),dA<dB){if(dA<limit)return snapA}else if(dB<limit)return snapB;return coor},self.triangleSides=function(A,B,C){return[self.pointToPointDistance(B,C),self.pointToPointDistance(A,C),self.pointToPointDistance(A,B)].sort(function(a,b){return a-b})},self.triangleIsRight=function(A,B,C){var t=self.triangleSides(A,B,C),a=t[0],b=t[1],c=t[2];return a*a+b*b==c*c},self.triangleIsAcute=function(A,B,C){var t=self.triangleSides(A,B,C),a=t[0],b=t[1],c=t[2];return a*a+b*b>c*c},self.triangleIsObtuse=function(A,B,C){var t=self.triangleSides(A,B,C),a=t[0],b=t[1],c=t[2];return a*a+b*b<c*c},self}(),DBSDM.Hash=function(){var self={};return self.string=function(str){var i,chr,len,hash=0;if(0===str.length)return hash;for(i=0,len=str.length;i<len;i++)chr=str.charCodeAt(i),hash=(hash<<5)-hash+chr,hash|=0;return hash>>>0},self.object=function(obj){return self.string(JSON.stringify(obj))},self}(),DBSDM.History=function(){function History(){this._undolog=[],this._redolog=[],this._last=null,this._transaction=[],this._level=0,this._canRecord=!0,this._paused=!1}return History.prototype.clear=function(){this._undolog=[],this._redolog=[],this._last=null,this._transaction=[],this._level=0},History.prototype.pause=function(){this._paused=!0},History.prototype.resume=function(){this._paused=!1},History.prototype.begin=function(){this._canRecord&&!this._paused&&0==this._level++&&(this._transaction=[])},History.prototype.commit=function(){this._canRecord&&!this._paused&&0==--this._level&&(this._undolog.push([null,this._transaction]),this._redolog=[],this._transaction=[])},History.prototype.record=function(context,name,from,to,stackable){this._canRecord&&!this._paused&&(stackable="undefined"==typeof stackable||stackable,stackable&&this._last&&this._last[0]===context&&this._last[1]===name?this._last[3]=to:(this._last=[context,name,from,to],this._level>0?this._transaction.push(this._last):(this._undolog.push(this._last),this._redolog=[])))},History.prototype.redo=function(){var entry=this._redolog.pop();entry&&(this._undolog.push(entry),this._last=entry,this._canRecord=!1,entry[0]?entry[0].playback(entry[1],entry[2],entry[3]):entry[1].forEach(function(part){part[0].playback(part[1],part[2],part[3])}),this._canRecord=!0)},History.prototype.undo=function(){var i,part,entry=this._undolog.pop();if(entry){if(this._redolog.push(entry),this._last=0!=this._undolog.length?this._undolog[this._undolog.length-1]:null,this._canRecord=!1,entry[0])entry[0].playback(entry[1],entry[3],entry[2]);else for(i=entry[1].length-1;i>=0;i--)part=entry[1][i],part[0].playback(part[1],part[3],part[2]);this._canRecord=!0}},History.prototype.hasUndo=function(){return 0!==this._undolog.length},History.prototype.hasRedo=function(){return 0!==this._redolog.length},History}(),DBSDM.Layout=function(){function Layout(){this._objects=null,this._relations=null}var ns=DBSDM,iterations=100,optimal=100,attractionScale=.25,straightenScale=.1,repulsionScale=25,repulsionDistanceScale=2,applyScale=1,origin={x:10,y:10};return Layout.prototype.sort=function(canvasObjects,relations){this._objects=canvasObjects,this._relations=relations,applyScale=1,this._fit();for(var i=0;i<iterations;i++)this._computeRelationsStrenghts(),this._computeObjectsRepulsions(),this._applyForces();this._moveToOrigin()},Layout.prototype._fit=function(){var i,count=this._objects.length;for(i=0;i<count;i++)this._objects[i].fitToContents()},Layout.prototype._computeRelationsStrenghts=function(){var i,force,rot,length,relations=this._relations,count=relations.length;for(i=0;i<count;i++)force=relations[i].getVector(),rot=Math.abs(force.x)<Math.abs(force.y)?new ns.Geometry.Vector(force.x,0):new ns.Geometry.Vector(0,force.y),length=force.getManhattan(),0!=length&&(force.multiply(.5*attractionScale*(length-optimal)/length),relations[i].addForceToEntities(force),rot.multiply(-.5*straightenScale*(rot.getManhattan()-optimal)/length),relations[i].addForceToEntities(rot))},Layout.prototype._computeObjectsRepulsions=function(){var i,centerA,j,centerB,length,force,objects=this._objects,count=objects.length;for(i=0;i<count;i++)if(!objects[i].hasParent||!objects[i].hasParent())for(centerA=objects[i].getCenter(),j=i+1;j<count;j++)objects[j].hasParent&&objects[j].hasParent()||(centerB=objects[j].getCenter(),length=ns.Geometry.pointToPointDistance(centerA,centerB),length>optimal*repulsionDistanceScale||(force=(new ns.Geometry.Vector).fromPoints(centerA,centerB).multiply(repulsionScale*optimal/(length*length)),objects[i].addForce(force.getOpposite()),objects[j].addForce(force)))},Layout.prototype._applyForces=function(){for(var i=0;i<this._objects.length;i++)this._objects[i].applyForce(applyScale)},Layout.prototype._moveToOrigin=function(){var i,vector,objects=this._objects,edges=objects[0].getEdges(),local={x:edges.left,y:edges.top},count=objects.length;for(i=1;i<count;i++)edges=objects[i].getEdges(),edges.left<local.x&&(local.x=edges.left),edges.top<local.y&&(local.y=edges.top);for(vector=(new ns.Geometry.Vector).fromPoints(local,origin),i=0;i<count;i++)objects[i].addForce(vector),objects[i].applyForce(1)},Layout}(),DBSDM.Menu=function(){var definition,ns=DBSDM,self={};return self._loadLocalStorage=function(){var prefix,local,i,key,result;if(!ns.Diagram.allowRecent)return"";for(prefix=ns.Consts.LocalStoragePrefix,local=[],i=0;i<localStorage.length;i++)key=localStorage.key(i),new RegExp("^"+prefix).test(key)&&local.push(localStorage.key(i));for(local.sort().reverse(),result=[],i=0;i<Math.min(local.length,10);i++)result.push([local[i].substring(prefix.length),"local#"+local[i],null,"allowRecent"]);return result.push(["Clear local storage","clear-local","trash-o","allowRecent"]),result},definition={attribute:[["Primary","primary","key","allowEdit"],["Unique","unique",["check-square-o","square-o"],"allowEdit"],["Nullable","nullable",["check-square-o","square-o"],"allowEdit"],["Delete Attribute","delete","ban","allowEdit"]],entity:[["Add Attribute","attr","list","allowEdit"],["Add Relation",[["N:M","rel-nm"],["N:1","rel-n1"],["1:N","rel-1n"],["1:1","rel-11"]],"link","allowEdit"],["Is a...","isa",null,"allowEdit"],["Fit to contents","fit"],["Order",[["Send to Front","tofront","level-up"],["Send to Back","toback","level-down"]]],["Delete Entity","delete","ban","allowEdit"]],note:[["Fit to contents","fit"],["Order",[["Send to Front","tofront","level-up"],["Send to Back","toback","level-down"]]],["Delete Note","delete","ban","allowEdit"]],relationMiddle:[["Reset point","reset","refresh"]],relationCP:[["Remove point","cp-delete"]],relationLeg:[["Cardinality",[["One","one",["check-circle","circle"]],["Many","many",["check-circle","circle"]]],null,"allowEdit"],["Identifying","identifying",["check-square-o","square-o"],"allowEdit"],["Required","required",["check-square-o","square-o"],"allowEdit"],["XOR with...","xor",null,"allowEdit"],["Remove from XOR","remove-xor",null,"allowEdit"],["Toggle Name","name",["check-square-o","square-o"]]],relation:[["Swap",[["All","swap"],["Cardinality","swap-card"],["Identifying","swap-ident"],["Required","swap-req"]],"exchange"],["Straighten","straighten","compress"],["Order",[["Send to Front","tofront","level-up"],["Send to Back","toback","level-down"]]],["Delete Relation","delete","ban","allowEdit"]],canvas:[["New...",[["Entity","new-entity","list-alt"],["Note","new-note","sticky-note-o"]],"plus","allowEdit"],["Show...",[["Relation names","toggle-rel-names",["check-square-o","square-o"]],["Notes","toggle-notes",["check-square-o","square-o"]]],"eye"],["Snap to grid","snap","th"],["Zoom",[["In","zoom-in","search-plus"],["Reset","zoom-reset","search"],["Out","zoom-out","search-minus"]],"search"],["Reset view","reset-view","arrows-alt"],["Fullscreen","fullscreen","desktop"],["Undo","undo","undo"],["Redo","redo","repeat"],["Save as...",[["Model (JSON)","save-model","file-text-o","allowFile"],["Data (JSON)","save-data","file-code-o","allowFile"],["Image (PNG)","save-image","file-image-o","allowFile"]],"floppy-o","allowFile"],["Recent...",self._loadLocalStorage,"folder-open-o","allowRecent"],["Clear","clear","eraser","allowEdit"]]},self._dom=null,self._handlers=null,self._params=null,self.build=function(){function createIconElement(icon){var dom=document.createElement("i");return"object"==typeof icon?(dom.className="fa fa-"+icon[0],dom.dataset.on="fa-"+icon[0],dom.dataset.off="fa-"+icon[1]):dom.className="fa fa-"+icon,dom}function createIcon(icon){var dom=document.createElement("div");return dom.className="icon",icon?dom.appendChild(createIconElement(icon)):dom.innerHTML="&nbsp;",dom}function createMenu(menu,parentEnabled){var i,title,options,icon,enabled,itemDom,dom=document.createElement("ul");for(i in menu)menu.hasOwnProperty(i)&&(title=menu[i][0],options=menu[i][1],icon=menu[i][2]||null,enabled=menu[i][3]?self.checkPermission(menu[i][3]):parentEnabled,"function"==typeof options&&(options=options()),itemDom=document.createElement("li"),"object"==typeof options?(itemDom.appendChild(createIconElement("caret-right")),itemDom.appendChild(createMenu(options,enabled))):itemDom.dataset.action=options,enabled||itemDom.classList.add("disabled"),itemDom.appendChild(createIcon(icon)),itemDom.appendChild(document.createTextNode(title)),dom.appendChild(itemDom));return dom}var dom,section,sectionDom;self._dom&&self._dom.menu&&self._dom.menu.remove(),self._dom={menu:null,sections:{}},self._handlers={attached:{},active:{}},self._params={},dom=document.createElement("div"),dom.id="dbsdmContextMenu";for(section in definition)definition.hasOwnProperty(section)&&(sectionDom=createMenu(definition[section],!0),sectionDom.dataset.handler=section,dom.appendChild(sectionDom),this._dom.sections[section]=sectionDom);document.body.appendChild(dom),this._dom.menu=dom,dom.onmousedown=function(e){e.stopPropagation()},dom.onclick=function(e){DBSDM.Menu.onClick(e)},ns.Fullscreen.enabled()||dom.querySelector("li[data-action=fullscreen]").classList.add("disabled")},self.checkPermission=function(permission){return ns.Diagram[permission]},self._updateMenuState=function(section){var dom,state,key,li,icon,handler=this._handlers.active[section];if(handler.getMenuState){dom=this._dom.sections[section],state=handler.getMenuState();for(key in state){if(!state.hasOwnProperty(key))return;li=dom.querySelector("li[data-action="+key+"]"),li&&(icon=li.querySelector("i.fa"),icon&&icon.dataset.on&&icon.dataset.off?(icon.classList.remove(icon.dataset.off),icon.classList.remove(icon.dataset.on),state[key]?icon.classList.add(icon.dataset.on):icon.classList.add(icon.dataset.off)):state[key]?li.classList.remove("disabled"):li.classList.add("disabled"))}}},self.attach=function(handler,section,params){this._dom.sections.hasOwnProperty(section)&&!this._handlers.attached.hasOwnProperty(section)&&(this._handlers.attached[section]=handler,this._dom.sections[section].style.display="none",this._params[section]=params||null)},self.hasAttachedHandlers=function(){return 0!=Object.keys(this._handlers.attached).length},self.show=function(e){var show,section,doc,left,top,parent;if(!this.hasAttachedHandlers())return void this.hide();this._handlers.active={},Object.assign(this._handlers.active,this._handlers.attached),this._handlers.attached={},show=!1;for(section in this._dom.sections)this._dom.sections.hasOwnProperty(section)&&this._handlers.active.hasOwnProperty(section)?(this._dom.sections[section].style.display="block",show=!0,this._updateMenuState(section)):this._dom.sections[section].style.display="none";if(!show)return void this.hide();for(doc=document.documentElement,left=e.clientX,top=e.clientY,ns.Fullscreen.inFullscreen()||(left+=(window.pageXOffset||doc.scrollLeft)-(doc.clientLeft||0),top+=(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0)),this._dom.menu.style.left=left+"px",this._dom.menu.style.top=top+"px",this._dom.menu.style.display="block",e.preventDefault(),parent=e.target.parentNode;parent&&!parent.classList.contains("dbsdmCanvas");)parent=parent.parentNode;parent.classList.contains("fullscreen")&&parent.appendChild(this._dom.menu)},self.hide=function(){this._dom.menu.style.display="none",this._dom.menu.parentNode!=document.body&&document.body.appendChild(this._dom.menu)},self.onClick=function(e){for(var action,handler,node=e.target;node&&node.dataset&&!(action=node.dataset.action);)node=node.parentNode;if(action&&!node.classList.contains("disabled")){for(;node&&node.dataset&&!(handler=node.dataset.handler);)node=node.parentNode;handler&&this._handlers.active[handler]&&this._handlers.active[handler].handleMenu&&(this._handlers.active[handler].handleMenu(action,this._params[handler]),this.hide())}},self}(),DBSDM.Mouse=function(){function Mouse(canvas){this._canvas=canvas,this._node=canvas.svg,this._targetObject=null,this._attachedObject=null,this._params={},this._down=!1,this._move=!1,this.button=null,this.x=0,this.y=0,this.ox=0,this.oy=0,this.dx=0,this.dy=0,this.rx=0,this.ry=0}var ns=DBSDM,timer=0,first={x:0,y:0};return Mouse.prototype.attachObject=function(object,params){this._attachedObject=object,this._params=params||{}},Mouse.prototype.detachObject=function(){this._attachedObject=null,this._params={}},Mouse.prototype.getParams=function(){return this._params},Mouse.prototype.setParam=function(name,value){this._params[name]=value},Mouse.prototype.getTarget=function(){return this._targetObject},Mouse.prototype.update=function(e){var gs,offset=this._node.getBoundingClientRect();this.x=(e.clientX-offset.left)/this._canvas._zoom,this.y=(e.clientY-offset.top)/this._canvas._zoom,1!=this.button&&(this.x+=this._canvas._offset.x,this.y+=this._canvas._offset.y,this._canvas.snap&&(gs=ns.Consts.CanvasGridSize,this.x=Math.ceil(this.x/gs)*gs,this.y=Math.ceil(this.y/gs)*gs))},Mouse.prototype.isDown=function(){return this._down},Mouse.prototype.didMove=function(){return this._move},Mouse.prototype.down=function(e,object,params){if(ns.Diagram.lastCanvas=this._canvas,this._targetObject=object,this._canvas.ui.shown()&&!this._canvas.ui.inTutorial&&this._canvas.ui.hideMessage(),e.stopPropagation(),!this._attachedObject){if(1==e.button)object=this._canvas,params=null,e.preventDefault();else if(0!=e.button)return;this.button=e.button,DBSDM.Menu.hide(),this.attachObject(object,params),this._attachedObject&&(this._down=!0,this.update(e),this.ox=this.x,this.oy=this.y,this.dx=0,this.dy=0,this.rx=0,this.ry=0,this._attachedObject.onMouseDown&&this._attachedObject.onMouseDown(e,this))}},Mouse.prototype.move=function(e){var x,y;e.stopPropagation(),this._attachedObject&&(x=this.x,y=this.y,this.update(e),this._move=this._move||0!=this.rx||0!=this.ry,this.dx=this.x-this.ox,this.dy=this.y-this.oy,this.rx=this.x-x,this.ry=this.y-y,this._attachedObject.onMouseMove&&this._attachedObject.onMouseMove(e,this))},Mouse.prototype.up=function(e){e.stopPropagation(),this._attachedObject&&(this.update(e),this._attachedObject.onMouseUp&&this._attachedObject.onMouseUp(e,this),this._attachedObject.onMouseDblClick&&(0==this.button?first.x==this.x&&first.y==this.y&&Date.now()-timer<ns.Consts.DoubleClickInterval?(timer=0,this._attachedObject.onMouseDblClick(e,this)):(timer=Date.now(),first.x=this.x,first.y=this.y):timer=0),this.detachObject(),this._down=!1,this._move=!1,this.button=null)},Mouse.prototype.enter=function(e,object){this._targetObject=object,e.stopPropagation(),0!=e.button||this._attachedObject||this._attachedObject&&this._attachedObject.onMouseEnter&&this._attachedObject.onMouseEnter(e,this)},Mouse.prototype.leave=function(e){this._targetObject=null,e.stopPropagation(),0!=e.button||this._attachedObject||this._attachedObject&&this._attachedObject.onMouseLeave&&this._attachedObject.onMouseLeave(e,this)},Mouse}(),DBSDM.Random={string:function(length){var i,chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",str="";for(i=0;i<length;i++)str+=chars.charAt(Math.floor(Math.random()*chars.length));return str},id:function(length){var chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",str=chars.charAt(Math.floor(Math.random()*chars.length));return str+=DBSDM.Random.string(length-1)}},DBSDM.UI=function(){function UI(container,canvas){var ledge,that;this._canvas=canvas,this._ui=document.createElement("div"),this._ui.className="ui",this._message=this._ui.appendChild(this._createMessage()),this._zoom=null,this._help=null,ledge=document.createElement("div"),ledge.className="ledge",ns.Diagram.allowCorrectMode&&(this._cModeSwitch=ledge.appendChild(this._createCorrectionModeSwitch())),ledge.appendChild(this._createHistoryControls()),ledge.appendChild(this._createZoomControls()),this._helpSwitch=ledge.appendChild(this._createHelp()),this._ui.appendChild(ledge),container.appendChild(this._ui),this._shown=!1,this._timer=!1,this._tutorialCurrent=null,ns.Diagram.showTutorial?(this.inTutorial=!0,this._tutorialLeft=["Entity","Menu","Select","Scroll"]):(this.inTutorial=!1,this._tutorialLeft=[]),that=this,this._message.addEventListener("click",function(e){that.hideMessage()})}var ns=DBSDM,tutorial={Entity:"Start by <strong>drawing</strong> an entity or <strong>dragging</strong> an exported JSON or SQL Developer zip file into canvas",Select:"<strong>Click</strong> on <i>Entity</i> to select it",Menu:"<strong>Right click</strong> on <i>any element</i> of the canvas to get more options",Scroll:"Click and drag <strong>middle mouse button</strong> to move the layout"};return UI.prototype._createMessage=function(){var message=document.createElement("div");return message.className="message",message.style.transitionDuration=ns.Consts.UIMessageTransition+"s",message},UI.prototype._createZoomControls=function(){var canvas,a,zoom=document.createElement("div");return zoom.className="zoom",canvas=this._canvas,a=document.createElement("a"),a.innerHTML="<i class='fa fa-search-plus'></i>",a.addEventListener("click",function(){canvas.zoomIn()}),zoom.appendChild(a),a=document.createElement("a"),a.className="reset",a.innerHTML="100%",a.addEventListener("click",function(){canvas.zoomReset()}),this._zoom=a,zoom.appendChild(a),a=document.createElement("a"),a.innerHTML="<i class='fa fa-search-minus'></i>",a.addEventListener("click",function(){canvas.zoomOut()}),zoom.appendChild(a),zoom},UI.prototype._createHelp=function(){var that,a=document.createElement("a");return a.className="uiIcon",a.innerHTML="<i class='fa fa-info-circle'></i>",that=this,a.addEventListener("click",function(){that.toggleHelp()}),a},UI.prototype._createCorrectionModeSwitch=function(){var that,a=document.createElement("a");return a.className="uiIcon",a.innerHTML="<i class='fa fa-check-circle-o'></i>",that=this,a.addEventListener("click",function(){that._toggleCorrectionMode()}),a},UI.prototype._createHistoryControls=function(){var that=this,f=document.createDocumentFragment(),a=document.createElement("a");return a.className="uiIcon",a.innerHTML="<i class='fa fa-undo'></i>",a.title="Undo",a.addEventListener("click",function(){that._canvas.History.undo()}),f.appendChild(a),a=document.createElement("a"),a.className="uiIcon",a.innerHTML="<i class='fa fa-repeat'></i>",a.title="Redo",a.addEventListener("click",function(){that._canvas.History.redo()}),f.appendChild(a),f},UI.prototype.updateZoomLevels=function(zoom){this._zoom.innerHTML=Math.round(100*zoom)+"%"},UI.prototype.advanceTutorial=function(){if(this.inTutorial)if(0==this._tutorialLeft.length)this.inTutorial=!1,this._tutorialCurrent=null,this.hideMessage();else{var action=this._tutorialLeft.shift();this._tutorialCurrent=action,this.hint(tutorial[action])}},UI.prototype.acceptTutorialAction=function(action){if(this.inTutorial){var index=this._tutorialLeft.lastIndexOf(action);index!=-1&&this._tutorialLeft.splice(index,1),this._tutorialCurrent==action&&this.advanceTutorial()}},UI.prototype.hint=function(message,time,callback){this._showMessage("hint",message,time,callback)},UI.prototype.error=function(message,time,callback){this._showMessage("error",message,time,callback)},UI.prototype.success=function(message,time,callback){this._showMessage("success",message,time,callback)},UI.prototype._showMessage=function(className,message,time,callback){var that,icon;if(window.clearTimeout(this._timer),this._shown)return that=this,void this.hideMessage(function(){that._showMessage(className,message,time,callback)});switch(this._message.classList.remove("success"),this._message.classList.remove("error"),this._message.classList.remove("hint"),icon="",className){case"hint":icon="bell";break;case"error":icon="exclamation-triangle";break;case"success":icon="check"}this._shown=!0,this._message.classList.add(className),this._message.style.marginTop=0,this._message.innerHTML='<i class="fa fa-'+icon+'"></i>'+message,this._timeMessage(time,callback)},UI.prototype.hideMessage=function(callback){this._shown=!1;var bounds=this._message.getBoundingClientRect();this._message.style.marginTop="-"+(bounds.height+5)+"px",callback&&(this._timer=window.setTimeout(callback,1e3*ns.Consts.UIMessageTransition))},UI.prototype._timeMessage=function(time,callback){if(time){if(!callback){var that=this;callback=function(){that.hideMessage()}}this._timer=window.setTimeout(callback,1e3*time)}},UI.prototype.shown=function(){return this._shown},UI.prototype.toggleHelp=function(){var data,div,content,headline,i;if(this._help)return this._help.remove(),this._help=null,void this._helpSwitch.classList.remove("active");this._helpSwitch.classList.add("active"),data={Basics:[["Import","Drag JSON file or zip of SQL Developer DMD onto canvas"],["New entity","Click and drag or double click"]],"Shortcuts on selected Entity":[["DEL","Delete Entity"],["a, [Dbl click]","Add new attribute"],["r","Create new 1:N relation"],["f","Fit to contents"],["i","Initiate ISA creation"]],"When editing Attribute":[["TAB","Select next or create new"],["SHIFT + TAB","Select previous"],["[Leave empty]","Delete attribute"]]},div=document.createElement("div"),div.className="help",content="";for(headline in data)if(data.hasOwnProperty(headline)){for(content+=headline+"<table>",i=0;i<data[headline].length;i++)content+="<tr><td>"+data[headline][i][0]+"</td><td>"+data[headline][i][1]+"</td></tr>";content+="</table>"}div.innerHTML=content,this._help=this._ui.appendChild(div)},UI.prototype._toggleCorrectionMode=function(){if(ns.Diagram.allowCorrectMode)if(this._canvas.inCorrectionMode=!this._canvas.inCorrectionMode,this._canvas.inCorrectionMode){this._cModeSwitch.classList.add("active"),this._canvas.setMode("correction");var that=this;ns.Diagram.cancelAction=function(){that._toggleCorrectionMode()}}else this._cModeSwitch.classList.remove("active"),this._canvas.unsetMode("correction"),ns.Diagram.cancelAction=null},UI}(),DBSDM.Geometry=DBSDM.Geometry||{},DBSDM.Geometry.Vector=function(){function Vector(x,y){this.x=x||0,this.y=y||0}var ns=DBSDM;return Vector.prototype.fromPoints=function(A,B){return this.x=B.x-A.x,this.y=B.y-A.y,this},Vector.prototype.reset=function(){this.x=0,this.y=0},Vector.prototype.add=function(vector){this.x+=vector.x,this.y+=vector.y},Vector.prototype.multiply=function(scalar){return this.x*=scalar,this.y*=scalar,this},Vector.prototype.normalize=function(){var len=this.getLength();return 0!=len&&this.multiply(1/len),this},Vector.prototype.getLength=function(){return Math.sqrt(this.y*this.y+this.x*this.x)},Vector.prototype.getManhattan=function(){return Math.abs(this.x)+Math.abs(this.y)},Vector.prototype.getOpposite=function(){return new ns.Geometry.Vector(-this.x,-this.y)},Vector}(),DBSDM.Control=DBSDM.Control||{},DBSDM.Control.Attribute=function(){function Attribute(list,model,canvas,entityControl){this._list=list,this._canvas=canvas,this._model=model||new DBSDM.Model.Attribute,this._entityControl=entityControl,this._view=new ns.View.Attribute(this._model,this,canvas),this.draw(),this._dragOffset=null,this._dragStartPosition=null,this._dragCurrentPosition=null}var ns=DBSDM;return Attribute.prototype.draw=function(){this._view.create(this,this._entityControl.getAttrContainer())},Attribute.prototype.delete=function(){this._list.removeAttribute(this._model,this),this._view.destroy()},Attribute.prototype.getPosition=function(){return this._list.getPosition(this._model)},Attribute.prototype.reposition=function(){this._view.reposition()},Attribute.prototype.getMinimalSize=function(){return this._view.getMinimalSize()},Attribute.prototype.selectAt=function(index,create){this._list.select(index,create)},Attribute.prototype.select=function(){this._view.showInput()},Attribute.prototype._toggleIncorrect=function(){this._model.incorrect=!this._model.incorrect,this._model.incorrect?this._view.markIncorrect():this._view.markCorrect()},Attribute.prototype.setName=function(name){var oldName=this._model.getName();oldName!=name&&(this._model.setName(name),this._canvas.History.record(this,"name",oldName,name,!1))},Attribute.prototype._togglePrimary=function(){this._model.setPrimary(!this._model.isPrimary()),this._view.redrawIndex()},Attribute.prototype._toggleUnique=function(){this._model.setUnique(!this._model.isUnique()),this._view.redrawIndex()},Attribute.prototype._toggleNullable=function(){this._model.setNullable(!this._model.isNullable()),this._view.redrawNullable()},Attribute.prototype.handleMenu=function(action){switch(action){case"primary":this._togglePrimary(),this._canvas.History.record(this,"primary",null,null,!1);break;case"unique":this._toggleUnique(),this._canvas.History.record(this,"unique",null,null,!1);break;case"nullable":this._toggleNullable(),this._canvas.History.record(this,"nullable",null,null,!1);break;case"delete":this.delete()}},Attribute.prototype.getMenuState=function(){return{unique:this._model.isUnique(),nullable:this._model.isNullable()}},Attribute.prototype.onMouseDown=function(e,mouse){this._canvas.inCorrectionMode||ns.Diagram.allowEdit&&(this._dragOffset=e.clientY-this._view.getEdges().top,this._dragStartPosition=this._list.getPosition(this._model),this._dragCurrentPosition=this._dragStartPosition,this._view.dragStarted())},Attribute.prototype.onMouseMove=function(e,mouse){var delta,position;this._canvas.inCorrectionMode||ns.Diagram.allowEdit&&(delta=Math.floor((mouse.dy+this._dragOffset)/18),position=this._dragStartPosition+delta,position!=this._dragCurrentPosition&&(this._dragCurrentPosition=this._list.setPosition(this._model,position)))},Attribute.prototype.onMouseUp=function(e,mouse){return this._canvas.inCorrectionMode?void this._toggleIncorrect():(this._dragStartPosition!=this._dragCurrentPosition&&this._canvas.History.record(this,"position",this._dragStartPosition,this._dragCurrentPosition,!1),void this._view.dragEnded())},Attribute.prototype.playback=function(action,from,to){switch(action){case"name":this.setName(to),this._view.redrawName();break;case"position":this._list.setPosition(this._model,to);break;case"primary":this._togglePrimary();break;case"unique":this._toggleUnique();break;case"nullable":this._toggleNullable()}},Attribute}(),DBSDM.Control=DBSDM.Control||{},DBSDM.Control.AttributeList=function(){function AttributeList(model,canvas,entityControl){this._model=model,this._canvas=canvas,this._entityControl=entityControl,this._controls=[]}var ns=DBSDM;return AttributeList.prototype.createAttribute=function(){var attrModel,control;ns.Diagram.allowEdit&&(attrModel=new ns.Model.Attribute,this._model.add(attrModel),control=this._createAttributeControl(attrModel),this._entityControl.encompassContent(),control.select(),this._canvas.History.record(this,"create",null,control,!1))},AttributeList.prototype._createAttributeControl=function(attributeModel){var control=new ns.Control.Attribute(this,attributeModel,this._canvas,this._entityControl);return this._controls.push(control),control},AttributeList.prototype.draw=function(){var i,list=this._model.getList(),count=list.length;for(i=0;i<count;i++)this._createAttributeControl(list[i])},AttributeList.prototype.redraw=function(){for(var i=0;i<this._controls.length;i++)this._controls[i].draw()},AttributeList.prototype.removeAttribute=function(attrModel,control){this._model.remove(attrModel);var index=this._controls.findIndex(function(element,index,array){return element==control});this._controls.splice(index,1),this._updatePositions(),this._canvas.History.record(this,"delete",[attrModel,control,index],null,!1)},AttributeList.prototype.getPosition=function(attrModel){return this._model.getPosition(attrModel)},AttributeList.prototype.setPosition=function(attrModel,position){
return position<0?position=0:position>this._model.getSize()&&(position=this._model.getSize()-1),this._model.setPosition(attrModel,position),this._updatePositions(),position},AttributeList.prototype.select=function(index,create){create="boolean"!=typeof create||create;var count=this._controls.length;index<count||!create?0!=count&&(index=Math.max(0,Math.min(count-1,index)),this._controls[index].select()):this.createAttribute()},AttributeList.prototype._updatePositions=function(){for(var i=0;i<this._controls.length;i++)this._controls[i].reposition()},AttributeList.prototype.getMinimalSize=function(){var i,a,size={width:0,height:0};for(i=0;i<this._controls.length;i++)a=this._controls[i].getMinimalSize(),size.width=Math.max(size.width,a.width),size.height+=a.height;return size},AttributeList.prototype.playback=function(action,from,to){switch(action){case"delete":if(to){var model=to[0],control=to[1],position=to[2];this._model.add(model),this._controls.push(control),this.setPosition(model,position),control.draw()}else from[1].delete();break;case"create":to?(this._model.add(to._model),this._controls.push(to),to.draw()):from.delete()}},AttributeList}(),DBSDM.Control=DBSDM.Control||{},DBSDM.Control.CanvasObject=function(){function CanvasObject(canvas,model){this._canvas=canvas,this._model=model,this._view=null,this._neededSize={width:0,height:0},this._force=new ns.Geometry.Vector,CanvasObject.active&&CanvasObject.active.deactivate()}var ns=DBSDM;return CanvasObject.active=null,CanvasObject.prototype.getDom=function(){return this._view.getDom()},CanvasObject.prototype.getEdges=function(){return this._model.getEdges()},CanvasObject.prototype.drag=function(mouse){var initial,final,delta={x:mouse.rx,y:mouse.ry},tr=this._model.getTransform();return!this._canvas.snap||0==delta.x&&0==delta.y||(0!=delta.x&&(delta.x-=tr.x%ns.Consts.CanvasGridSize),0!=delta.y&&(delta.y-=tr.y%ns.Consts.CanvasGridSize)),initial=[tr.x,tr.y],this._model.translate(delta.x,delta.y),final=[tr.x,tr.y],this._canvas.History.record(this,"drag",initial,final),delta},CanvasObject.prototype.dragControlPoint=function(mouse,cp){var transform=this._model.getTransform(),x=null,y=null,width=null,height=null,cursor={x:mouse.x,y:mouse.y};/n/.test(cp)?(y=cursor.y,height=transform.y-y+transform.height):/s/.test(cp)&&(height=cursor.y-transform.y),/w/.test(cp)?(x=cursor.x,width=transform.x-x+transform.width):/e/.test(cp)&&(width=cursor.x-transform.x),this._setConstrainedTransform(x,y,width,height)},CanvasObject.prototype.notifyDrag=function(x,y){},CanvasObject.prototype._setConstrainedTransform=function(x,y,width,height){var initial,final,transform=this._model.getTransform();null!=width&&width<this._neededSize.width&&(width=this._neededSize.width,null!=x&&(x=transform.x+transform.width-this._neededSize.width)),null!=height&&height<this._neededSize.height&&(height=this._neededSize.height,null!=y&&(y=transform.y+transform.height-this._neededSize.height)),initial=[transform.x,transform.y,transform.width,transform.height],this._model.setPosition(x,y),this._model.setSize(width,height),final=[transform.x,transform.y,transform.width,transform.height],this._canvas.History.record(this,"resize",initial,final)},CanvasObject.prototype.computeNeededSize=function(){var size=this._view.getMinimalSize();this._neededSize.width=size.width,this._neededSize.height=size.height},CanvasObject.prototype.encompassContent=function(){var transform,width,height;return this.computeNeededSize(),transform=this._model.getTransform(),width=transform.width<this._neededSize.width?this._neededSize.width:null,height=transform.height<this._neededSize.height?this._neededSize.height:null,(null!=width||null!=height)&&(this._model.setSize(width,height),this._view.redraw(),!0)},CanvasObject.prototype.getCenter=function(){var transform=this._model.getTransform();return{x:transform.x+.5*transform.width,y:transform.y+.5*transform.height}},CanvasObject.prototype.resetForce=function(){this._force.reset()},CanvasObject.prototype.addForce=function(force){this._force.add(force)},CanvasObject.prototype.applyForce=function(modifier){modifier&&1!=modifier&&this._force.multiply(modifier),this._model.translate(this._force.x,this._force.y),this.notifyDrag(this._force.x,this._force.y),this._view.redraw(),this.resetForce()},CanvasObject.prototype.activate=function(){CanvasObject.active&&CanvasObject.active.deactivate(),CanvasObject.active=this,this._view.showControls()},CanvasObject.prototype.deactivate=function(){CanvasObject.active==this&&(CanvasObject.active=null,this._view.hideControls())},CanvasObject.prototype._toggleIncorrect=function(){this._model.incorrect=!this._model.incorrect,this._view.defaultMark()},CanvasObject.prototype.handleMenu=function(action){switch(action){case"delete":this.delete();break;case"fit":this.fitToContents();break;case"toback":this._view.toBack();break;case"tofront":this._view.toFront()}},CanvasObject.prototype.onMouseDown=function(e,mouse){if(!this._canvas.inCorrectionMode){var matches=e.target.className.baseVal.match(/e-cp-(\w+)/);matches&&(mouse.setParam("action","cp"),mouse.setParam("cp",matches[1]))}},CanvasObject.prototype.onKeyPress=function(e){switch(e.keyCode){case 46:this.delete();break;case 27:this.deactivate();break;case 34:this._view.toBack(),e.preventDefault();break;case 33:this._view.toFront(),e.preventDefault()}switch(e.key.toLowerCase()){case"f":this.fitToContents()}},CanvasObject.prototype.playback=function(action,from,to){switch(action){case"drag":this.drag({rx:to[0]-from[0],ry:to[1]-from[1]}),this._view.redraw();break;case"resize":this._setConstrainedTransform(to[0],to[1],to[2],to[3]),this._view.redraw()}},CanvasObject}(),DBSDM.Control=DBSDM.Control||{},DBSDM.Control.Entity=function(){function Entity(canvas,model){Super.call(this,canvas,model),this._attributeList=new ns.Control.AttributeList(this._model.getAttributeList(),this._canvas,this),this._relationLegList=[],this._xorLegList=[],this._view=new ns.View.Entity(this._canvas,this._model,this),this._parent=null,this._children=[],this._new=!0,this._ignoredInput={x:0,y:0}}var ns=DBSDM,Enum=ns.Enums,Super=ns.Control.CanvasObject;return Entity.prototype=Object.create(Super.prototype),Entity.prototype.constructor=Entity,Entity.prototype.getAttrContainer=function(){return this._view.getAttrContainer()},Entity.prototype.getModel=function(){return this._model},Entity.prototype.create=function(){var x=this._canvas.Mouse.x,y=this._canvas.Mouse.y;this._model.setPosition(x,y),this._view.createEmpty()},Entity.prototype.finish=function(){this._view.create(this),this._canvas.addEntity(this),this._new=!1,this._canvas.ui.acceptTutorialAction("Entity"),this.computeNeededSize(),this._canvas.History.record(this,"create",!1,!0,!1)},Entity.prototype.import=function(){return this._view.createEmpty(),this.finish(),this._attributeList.draw(),this.computeNeededSize(),this},Entity.prototype.place=function(obj){obj.dx<0&&this._model.setPosition(obj.x),obj.dy<0&&this._model.setPosition(null,obj.y),this._model.setSize(Math.abs(obj.dx),Math.abs(obj.dy)),this._view.redraw()},Entity.prototype.setName=function(name){this._model.setName(name),this.encompassContent()},Entity.prototype._setPosition=function(newX,newY){var x,y,padding,parentTransform,delta,transform=this._model.getTransform();return null!=this._parent?(padding=ns.Consts.EntityPadding,parentTransform=this._parent._model.getTransform(),x=Math.min(Math.max(newX-this._ignoredInput.x,padding),parentTransform.width-transform.width-padding),this._ignoredInput.x+=x-newX,y=Math.min(Math.max(newY-this._ignoredInput.y,padding),parentTransform.height-transform.height-padding),this._ignoredInput.y+=y-newY):(x=newX,y=newY),delta={x:x-transform.x,y:y-transform.y},this._model.setPosition(x,y),delta},Entity.prototype.drag=function(mouse){var delta,transform,initial,final;null!=this._parent?(transform=this._model.getTransform(),initial=[transform.x,transform.y],delta=this._setPosition(transform.x+mouse.rx,transform.y+mouse.ry),final=[transform.x,transform.y],this._canvas.History.record(this,"drag",initial,final)):delta=Super.prototype.drag.call(this,mouse),this.notifyDrag(delta.x,delta.y)},Entity.prototype.notifyDrag=function(x,y){var i,c,relCount=this._relationLegList.length;for(i=0;i<relCount;i++)this._relationLegList[i].onEntityDrag(x,y);for(i=0;i<relCount;i++)this._relationLegList[i].getRelation().onEntityDrag(x,y);for(c=0;c<this._children.length;c++)this._children[c].notifyDrag(x,y)},Entity.prototype.dragControlPoint=function(mouse,cp){var transform=this._model.getTransform(),x=null,y=null,width=null,height=null,cursor={x:mouse.x,y:mouse.y},parent=null;null!=this._parent&&(parent=this._parent.getEdges(),cursor.x-=parent.left,cursor.y-=parent.top),/n/.test(cp)?(y=null==parent?cursor.y:Math.max(cursor.y,ns.Consts.EntityEdgePadding),height=transform.y-y+transform.height):/s/.test(cp)&&(height=cursor.y-transform.y),/w/.test(cp)?(x=null==parent?cursor.x:Math.max(cursor.x,ns.Consts.EntityEdgePadding),width=transform.x-x+transform.width):/e/.test(cp)&&(width=cursor.x-transform.x),this._setConstrainedTransform(x,y,width,height),this._notifyResize()},Entity.prototype.resetPosition=function(){var t=this._model.getTransform(),delta=this._setPosition(t.x,t.y);this.notifyDrag(delta.x,delta.y),this._view.redraw()},Entity.prototype.encompassContent=function(){Super.prototype.encompassContent.call(this)&&this._notifyResize()},Entity.prototype._notifyResize=function(){var i,edges;for(i=0;i<this._children.length;i++)this._children[i].resetPosition();for(null!=this._parent&&this._parent.encompassContent(),edges=this._model.getEdges(),i=0;i<this._relationLegList.length;i++)this._relationLegList[i].onEntityResize(edges)},Entity.prototype.activate=function(){Super.prototype.activate.call(this),this._canvas.ui.acceptTutorialAction("Select")},Entity.prototype.delete=function(){if(ns.Diagram.allowEdit){this._canvas.History.begin(),this._canvas.removeEntity(this);for(var i=0;i<this._children.length;i++)this._children[i].delete();for(this._view.remove();this._relationLegList.length>0;)this._relationLegList[0].getRelation().clear();this._canvas.History.record(this,"delete",!0,!1,!1),this._canvas.History.commit()}},Entity.prototype.undoDelete=function(){ns.Diagram.allowEdit&&(this._canvas.addEntity(this),this._view.createEmpty(),this._view.create(this),this._attributeList.redraw())},Entity.prototype.getEdgePosition=function(edge){return this._model.getEdgePosition(edge)},Entity.prototype.getMinimalSize=function(){var count,childrenWidth,childrenHeight,i,ent,size=this._view.getMinimalSize(),attributes=this._attributeList.getMinimalSize();if(size.width+=attributes.width,size.height+=attributes.height,count=this._children.length,0!=count){for(childrenWidth=(2+count-1)*ns.Consts.EntityPadding,childrenHeight=0,i=0;i<count;i++)ent=this._children[i].getMinimalSize(),childrenWidth+=ent.width,childrenHeight=Math.max(childrenHeight,ent.height);size.width=Math.max(size.width,childrenWidth),size.height+=childrenHeight}return size},Entity.prototype.computeNeededSize=function(){var count,i,child,size=this._view.getMinimalSize(),attributes=this._attributeList.getMinimalSize();if(size.width+=attributes.width,size.height+=attributes.height,count=this._children.length,0!=count)for(i=0;i<count;i++)child=this._children[i]._model.getTransform(),size.width=Math.max(size.width,child.x+child.width+ns.Consts.EntityPadding),size.height=Math.max(size.height,child.y+child.height+ns.Consts.EntityPadding);this._neededSize.width=size.width,this._neededSize.height=size.height},Entity.prototype._createAttribute=function(){var tr,initial,final;this._canvas.History.begin(),tr=this._model.getTransform(),initial={width:tr.width,height:tr.height},this._attributeList.createAttribute(),final={width:tr.width,height:tr.height},this._canvas.History.record(this,"resize",initial,final,!1),this._canvas.History.commit()},Entity.prototype._createRelation=function(sourceCardinality,targetCardinality){if(ns.Diagram.allowEdit){var control=new ns.Control.Relation(this._canvas,this,null,sourceCardinality,targetCardinality);this._canvas.Mouse.attachObject(control),ns.Diagram.cancelAction=function(){control.cancel()}}},Entity.prototype.addRelationLeg=function(relationLegControl){this._relationLegList.indexOf(relationLegControl)===-1&&(this._relationLegList.push(relationLegControl),this._model.addRelation(relationLegControl.getModel()))},Entity.prototype.removeRelationLeg=function(relationLegControl){var i,index=null;for(i in this._relationLegList)if(this._relationLegList[i]==relationLegControl){index=i;break}null!=index&&(this._relationLegList.splice(index,1),this._model.removeRelation(relationLegControl.getModel()))},Entity.prototype.getEdgeCursorPosition=function(x,y){var edges=this._model.getEdges(),center={x:.5*(edges.left+edges.right),y:.5*(edges.top+edges.bottom)},EdgeOffset=ns.Consts.EntityEdgePadding;return edges.left+EdgeOffset<x&&x<edges.right-EdgeOffset?y>center.y?{x:x,y:edges.bottom,edge:Enum.Edge.BOTTOM}:{x:x,y:edges.top,edge:Enum.Edge.TOP}:edges.top+EdgeOffset<y&&y<edges.bottom-EdgeOffset?x<center.x?{x:edges.left,y:y,edge:Enum.Edge.LEFT}:{x:edges.right,y:y,edge:Enum.Edge.RIGHT}:null},Entity.prototype.importIsa=function(parentControl){this._parent=parentControl,this._model.setParent(parentControl.getModel()),this._view.setParent(parentControl.getDom()),this._canvas.removeEntity(this),parentControl.addChild(this),this._view.redraw()},Entity.prototype._isa=function(parent,pos){var tr,oldEdges,newEdges,parentTransform,i;if(ns.Diagram.allowEdit&&(pos=pos||this._canvas.Mouse,tr=this._model.getTransform(),this._canvas.History.begin(),this._canvas.History.record(this,"isa",{parent:this._parent,x:tr.x,y:tr.y},{parent:parent,x:pos.x,y:pos.y},!1),this._canvas.unsetMode("isa"),this._view.defaultMark(),this._parent!=parent)){for(oldEdges=this._model.getEdges(),null!=this._parent&&(this._parent.removeChild(this),this._model.setParent(null)),this._parent=parent,null==parent?(this._view.setParent(this._canvas.svg),this._canvas.addEntity(this),this._setPosition(pos.x,pos.y),newEdges=this._model.getEdges(),this.notifyDrag(newEdges.left-oldEdges.left,newEdges.top-oldEdges.top)):(parentTransform=parent._model.getTransform(),this._setPosition(pos.x-parentTransform.x,pos.y-parentTransform.y),this._model.setParent(parent._model),this._view.setParent(parent.getDom()),this._canvas.removeEntity(this),newEdges=this._model.getEdges(),this.notifyDrag(newEdges.left-oldEdges.left,newEdges.top-oldEdges.top),parent.addChild(this)),this._view.redraw(),i=0;i<this._relationLegList.length;i++)this._relationLegList[i].getRelation().straighten(),this._relationLegList[i].getRelation().redraw();this._canvas.History.commit()}},Entity.prototype._initIsa=function(){if(ns.Diagram.allowEdit){this._canvas.Mouse.attachObject(this),this._view.select(),this._canvas.svg.classList.add("isaMode");var that=this;ns.Diagram.cancelAction=function(){that.cancelIsa()}}},Entity.prototype.cancelIsa=function(){this._canvas.unsetMode("isa"),this._view.defaultMark(),this._canvas.Mouse.detachObject()},Entity.prototype.removeChild=function(child){this._model.removeChild(child);for(var i=0;i<this._children.length;i++)if(child==this._children[i]){this._children.splice(i,1);break}this.computeNeededSize()},Entity.prototype.addChild=function(child){var childTransform,transform,initial,neededWidth,neededHeight,final;this._model.addChild(child._model),this._children.push(child),childTransform=child._model.getTransform(),transform=this._model.getTransform(),initial={width:transform.width,height:transform.height},neededWidth=childTransform.width+2*ns.Consts.EntityPadding,neededHeight=childTransform.height+2*ns.Consts.EntityPadding,this._model.setSize(transform.width<neededWidth?neededWidth:null,transform.height<neededHeight?neededHeight:null),final={width:transform.width,height:transform.height},this._canvas.History.record(this,"resize",initial,final,!1),this._notifyResize(),this._view.redraw(),this.computeNeededSize()},Entity.prototype.fitToContents=function(){var offsetTop,offsetLeft,i,child,delta,tr=this._model.getTransform(),initial={width:tr.width,height:tr.height},size=this.getMinimalSize();if(this._model.setSize(size.width,size.height),this._canvas.History.record(this,"fit",initial,{width:size.width,height:size.height}),0!=this._children.length)for(offsetTop=this._view.getMinimalSize().height+this._attributeList.getMinimalSize().height,offsetLeft=ns.Consts.EntityPadding,i=0;i<this._children.length;i++)child=this._children[i].getMinimalSize(),this._children[i].fitToContents(),delta=this._children[i]._setPosition(offsetLeft,offsetTop),this.notifyDrag(delta.x,delta.y),this._children[i]._view.redraw(),offsetLeft+=ns.Consts.EntityPadding+child.width;return this._view.redraw(),this._notifyResize(),this},Entity.prototype._findXor=function(leg){var i,count=this._xorLegList.length;for(i=0;i<count;i++)if(this._xorLegList[i].indexOf(leg)!=-1)return i;return-1},Entity.prototype.xorWith=function(legA,legB){var index=this._findXor(legB);index!=-1?(this._xorLegList[index].push(legA),this._model.addToXor(index,legA.getModel())):(index=this._xorLegList.length,this._xorLegList.push([legA,legB]),this._model.createXor(legA.getModel(),legB.getModel())),this.redrawXor(index),this._canvas.History.record(this,"xor",null,[legA,legB],!1)},Entity.prototype.removeXorLeg=function(leg){var other,i,index,xorIndex=this._findXor(leg);if(xorIndex!=-1)if(other=this._xorLegList[xorIndex][0],other==leg&&(other=this._xorLegList[xorIndex][0]),this._canvas.History.record(this,"xor",[leg,other],null,!1),2==this._xorLegList[xorIndex].length)for(this._xorLegList[xorIndex][0].getModel().setAnchorOffset(ns.Consts.DefaultAnchorOffset),this._xorLegList[xorIndex][0].getRelation().onXorUpdate(),this._xorLegList[xorIndex][1].getModel().setAnchorOffset(ns.Consts.DefaultAnchorOffset),this._xorLegList[xorIndex][1].getRelation().onXorUpdate(),this._xorLegList.splice(xorIndex,1),this._model.removeXor(xorIndex),this._view.clearXor(xorIndex),i=xorIndex;i<this._xorLegList.length;i++)this.redrawXor(i);else index=this._xorLegList[xorIndex].indexOf(leg),this._xorLegList[xorIndex][index].getModel().setAnchorOffset(ns.Consts.DefaultAnchorOffset),leg.getRelation().onXorUpdate(),this._xorLegList[xorIndex].splice(index,1),this._model.removeXorLeg(xorIndex,index),this.redrawXor(xorIndex)},Entity.prototype.markRelations=function(leg,inXor){var i,otherLeg;for(i=0;i<this._relationLegList.length;i++)otherLeg=this._relationLegList[i],otherLeg!=leg&&(inXor&&otherLeg.getModel().inXor?otherLeg.mark():otherLeg.allow())},Entity.prototype.unmarkRelations=function(){for(var i=0;i<this._relationLegList.length;i++)this._relationLegList[i].clearMarks()},Entity.prototype.redrawXor=function(index,leg){var edges,edgeDistance,i,legControl,legModel;if(leg&&(index=this._findXor(leg)),!("undefined"==typeof index||null==index||index<0))for(edges=this._model.getEdges(),edgeDistance=ns.View.Arc.getEdgeDistance(index),this._view.drawXor(edges,index,edgeDistance),i=0;i<this._xorLegList[index].length;i++)legControl=this._xorLegList[index][i],legModel=legControl.getModel(),legModel.getAnchorOffset()!=edgeDistance&&(legModel.setAnchorOffset(edgeDistance),legControl.getRelation().onXorUpdate())},Entity.prototype.hasParent=function(){return this._model.hasParent()},Entity.prototype.handleMenu=function(action){switch(action){case"attr":this._createAttribute();break;case"rel-nm":this._createRelation(Enum.Cardinality.MANY,Enum.Cardinality.MANY);break;case"rel-n1":this._createRelation(Enum.Cardinality.MANY,Enum.Cardinality.ONE);break;case"rel-1n":this._createRelation(Enum.Cardinality.ONE,Enum.Cardinality.MANY);break;case"rel-11":this._createRelation(Enum.Cardinality.ONE,Enum.Cardinality.ONE);break;case"isa":this._initIsa();break;default:Super.prototype.handleMenu.call(this,action)}},Entity.prototype.onMouseMove=function(e,mouse){if(!this._canvas.inCorrectionMode)if(this._new)this.place(mouse);else if(mouse.isDown()){var params=mouse.getParams();"cp"==params.action?this.dragControlPoint(mouse,params.cp):this.drag(mouse),this._view.redraw()}},Entity.prototype.onMouseUp=function(e,mouse){if(this._canvas.inCorrectionMode)return void this._toggleIncorrect();if(this._new)0==mouse.dx||0==mouse.dy?(this._view.remove(),Super.active&&Super.active.deactivate()):(this.finish(),this.encompassContent());else if(mouse.didMove()){if(this._canvas.svg.classList.contains("isaMode")){var parent=mouse.getTarget();parent instanceof ns.Control.Entity&&parent!=this?this._isa(parent):this._isa(null)}}else this.activate();this._ignoredInput={x:0,y:0}},Entity.prototype.onMouseDblClick=function(e,mouse){var w,h;this.inCorrectionMode||(this._new?(w=ns.Consts.EntityDefaultWidth,h=ns.Consts.EntityDefaultHeight,this.create(),this._model.setPosition(mouse.x-.5*w,mouse.y-.5*h),this._model.setSize(w,h),this._view.redraw(),this.finish()):this._createAttribute())},Entity.prototype.onKeyPress=function(e){if(!this._canvas.inCorrectionMode&&!ns.View.EditableContent.shown){switch(e.key.toLowerCase()){case"a":this._createAttribute();break;case"r":this._createRelation(Enum.Cardinality.ONE,Enum.Cardinality.MANY);break;case"i":this._initIsa()}Super.prototype.onKeyPress.call(this,e)}},Entity.prototype.playback=function(action,from,to){switch(action){case"delete":case"create":to?this.undoDelete():this.delete();break;case"xor":to?this.xorWith(to[0],to[1]):this.removeXorLeg(from[0]);break;case"fit":case"resize":this._model.setSize(to.width,to.height),this._view.redraw(),this._notifyResize();break;case"isa":this._isa(to.parent,to),to.width&&(this._model.setSize(to.width,to.height),this._view.redraw(),this._notifyResize());break;default:Super.prototype.playback.call(this,action,from,to)}},Entity}(),DBSDM.Control=DBSDM.Control||{},DBSDM.Control.Note=function(){function Note(canvas,model){Super.call(this,canvas,model),this._view=new ns.View.Note(this._canvas,this._model,this)}var ns=DBSDM,Super=ns.Control.CanvasObject;return Note.prototype=Object.create(Super.prototype),Note.prototype.constructor=Note,Note.prototype.getDom=function(){return this._view.getDom()},Note.prototype.getModel=function(){return this._model},Note.prototype.create=function(){var final,x=this._canvas.Mouse.x,y=this._canvas.Mouse.y;this._model.setPosition(x,y),this._view.create(this),this._canvas.addNote(this),this.computeNeededSize(),this.encompassContent(),final=Object.assign({},this._model.getTransform()),this._canvas.History.record(this,"create",null,final)},Note.prototype.import=function(){return this._view.create(),this._canvas.addNote(this),this},Note.prototype.setText=function(text){var final,initial=Object.assign({},this._model.getTransform());initial.text=this._model.getText(),this._model.setText(text),this.encompassContent(),final=Object.assign({},this._model.getTransform()),final.text=text,this._canvas.History.record(this,"edit",initial,final)},Note.prototype.delete=function(){if(ns.Diagram.allowEdit){var initial=Object.assign({},this._model.getTransform());initial.text=this._model.getText(),this._canvas.removeNote(this),this._view.remove(),this._canvas.History.record(this,"delete",initial,null)}},Note.prototype.show=function(){this._view.show()},Note.prototype.hide=function(){this._view.hide()},Note.prototype.fitToContents=function(){var final,initial=Object.assign({},this._model.getTransform()),size=this._view.getMinimalSize();return this._model.setSize(size.width,size.height),this._view.redraw(),final=Object.assign({},this._model.getTransform()),this._canvas.History.record(this,"fit",initial,final),this},Note.prototype.handleMenu=function(action){Super.prototype.handleMenu.call(this,action)},Note.prototype.onMouseMove=function(e,mouse){if(!this._canvas.inCorrectionMode&&mouse.isDown()){var params=mouse.getParams();"cp"==params.action?this.dragControlPoint(mouse,params.cp):this.drag(mouse),this._view.redraw()}},Note.prototype.onMouseUp=function(e,mouse){return this._canvas.inCorrectionMode?void this._toggleIncorrect():void(mouse.didMove()||this.activate())},Note.prototype.onMouseDblClick=function(e,mouse){this._canvas.isInMode("correction")||this._canvas.isInMode("isa")||this._view.edit()},Note.prototype.onKeyPress=function(e){this._canvas.inCorrectionMode||ns.View.EditableContent.shown||Super.prototype.onKeyPress.call(this,e)},Note.prototype.playback=function(action,from,to){switch(action){case"create":case"delete":null==to?this.delete():(this._model.setPosition(to.x,to.y),this._model.setSize(to.width,to.height),to.text&&this._model.setText(to.text),this._view.create(),this._canvas.addNote(this));break;case"fit":case"edit":this._model.setPosition(to.x,to.y),this._model.setSize(to.width,to.height),this._view.redraw(),to.text&&(this._model.setText(to.text),this._view._text.redraw());break;default:Super.prototype.playback.call(this,action,from,to)}},Note}(),DBSDM.Control=DBSDM.Control||{},DBSDM.Control.Relation=function(){function Relation(canvas,sourceEntityControl,targetEntityControl,sourceCardinality,targetCardinality,model){this._canvas=canvas,this._sourceEntity=sourceEntityControl,this._targetEntity=targetEntityControl||null,this._new=!0;var source,target;model?(this._model=model,source=this._model.getSource(),target=this._model.getTarget()):(source=new ns.Model.RelationLeg(!1,!0,sourceCardinality),target=new ns.Model.RelationLeg(!0,!1,targetCardinality),this._model=new ns.Model.Relation(source,target)),this._legs={source:new ns.Control.RelationLeg(this,canvas,source),target:new ns.Control.RelationLeg(this,canvas,target)},this._view=new ns.View.Relation(this._canvas,this._model,this),this._view.draw(this._legs.source.getDom(),this._legs.target.getDom()),this._canvas.History.record(this,"create",!1,!0)}var ns=DBSDM,Enum=ns.Enums,RecursiveEntityOffset=20;return Relation.prototype._setupEntities=function(){this._new=!1,this._sourceEntity.addRelationLeg(this._legs.source),this._legs.source.setEntityControl(this._sourceEntity),this._targetEntity.addRelationLeg(this._legs.target),this._legs.target.setEntityControl(this._targetEntity),this._canvas.addRelation(this),this._model.middleManual=this._sourceEntity==this._targetEntity},Relation.prototype.import=function(manageRelations){this._setupEntities(),manageRelations&&this._moveToEntity(),this.redraw()},Relation.prototype.cancel=function(){this._new&&(this._new=!1,this._view.clear(),this._canvas.Mouse.detachObject())},Relation.prototype.getCanvas=function(){return this._canvas},Relation.prototype.getModel=function(){return this._model},Relation.prototype.redraw=function(){this._legs.source.redraw(),this._legs.target.redraw(),this._view.redraw()},Relation.prototype.redrawType=function(){this._legs.source.redrawType(),this._legs.target.redrawType()},Relation.prototype.clear=function(){this._sourceEntity.removeRelationLeg(this._legs.source),this._targetEntity.removeRelationLeg(this._legs.target),this._view.clear(),this._canvas.removeRelation(this),this._canvas.History.record(this,"clear",!0,!1)},Relation.prototype.undoClear=function(){this._legs.source.draw(),this._legs.target.draw(),this._view.draw(this._legs.source.getDom(),this._legs.target.getDom()),this._setupEntities(),this.redraw(),this.redrawType()},Relation.prototype.straighten=function(){this._model.straighten()},Relation.prototype.translate=function(dx,dy){this._legs.source.translate(dx,dy),this._legs.target.translate(dx,dy),this._model.translateMiddlePoint(dx,dy),this.redraw()},Relation.prototype.isRecursive=function(){return this._sourceEntity==this._targetEntity},Relation.prototype._moveMiddle=function(pos){var s=this._legs.source._model.getPoint(-2),t=this._legs.target._model.getPoint(-2),x=ns.Geometry.snap(pos.x,s.x,t.x,ns.Consts.SnappingLimit),y=ns.Geometry.snap(pos.y,s.y,t.y,ns.Consts.SnappingLimit),initial=Object.assign({manual:this._model.middleManual},this._model.getMiddlePoint());this._model.setMiddlePointPosition(x,y),this._model.middleManual=!0,this._canvas.History.record(this,"middle",initial,{x:x,y:y,manual:!0})},Relation.prototype.centerMiddlePoint=function(){this._model.middleManual||this._model.resetMiddlePoint(),this.redraw()},Relation.prototype._moveToCursor=function(x,y){var edgeLR,posLR,lenLR,edgeTB,posTB,lenTB,pos,edge,cursor={x:x,y:y},edges=this._sourceEntity.getEdges(),center={x:.5*(edges.left+edges.right),y:.5*(edges.top+edges.bottom)};return(x<edges.left||x>edges.right)&&(edgeLR=x<center.x?Enum.Edge.LEFT:Enum.Edge.RIGHT,posLR=this._sourceEntity.getEdgePosition(edgeLR),lenLR=ns.Geometry.pointToPointDistance(cursor,posLR)),(y<edges.top||y>edges.bottom)&&(edgeTB=y<center.y?Enum.Edge.TOP:Enum.Edge.BOTTOM,posTB=this._sourceEntity.getEdgePosition(edgeTB),lenTB=ns.Geometry.pointToPointDistance(cursor,posTB)),!lenTB||lenLR<=lenTB?(pos=posLR,edge=edgeLR):(pos=posTB,edge=edgeTB),pos?(this._model.getSource().setAnchor(pos.x,pos.y,edge),this._model.getTarget().setAnchor(x,y,(edge+2)%4),this._model.straighten(),void this.redraw()):void console.log("Can't find appropriate position")},Relation.prototype._moveToSameEntity=function(){var targetModel,posTarget,targetPoint,sourceModel=this._model.getSource(),posSource=this._sourceEntity.getEdgePosition(Enum.Edge.TOP),sourcePoint={x:posSource.x,y:posSource.y-RecursiveEntityOffset};sourceModel.setAnchor(posSource.x,posSource.y,Enum.Edge.TOP),2==sourceModel.getPointsCount()?sourceModel.addPoint(1,sourcePoint):sourceModel.setPoint(1,sourcePoint.x,sourcePoint.y),targetModel=this._model.getTarget(),posTarget=this._targetEntity.getEdgePosition(Enum.Edge.LEFT),targetPoint={x:posTarget.x-RecursiveEntityOffset,y:posTarget.y},targetModel.setAnchor(posTarget.x,posTarget.y,Enum.Edge.LEFT),2==targetModel.getPointsCount()?targetModel.addPoint(1,targetPoint):targetModel.setPoint(1,targetPoint.x,targetPoint.y),this._model.setMiddlePointPosition(posTarget.x-RecursiveEntityOffset,posSource.y-RecursiveEntityOffset),this.redraw()},Relation.prototype._moveToDifferentEntity=function(){this._model.straighten(!0,this._sourceEntity._model,this._targetEntity._model),this.redraw()},Relation.prototype._moveToEntity=function(){this._targetEntity==this._sourceEntity?this._moveToSameEntity():this._moveToDifferentEntity()},Relation.prototype.getVector=function(){var vector=new ns.Geometry.Vector(0,0);return this._sourceEntity!=this._targetEntity&&vector.fromPoints(this._model.getSource().getAnchor(),this._model.getTarget().getAnchor()),vector},Relation.prototype.addForceToEntities=function(force){this._sourceEntity.addForce(force),this._targetEntity.addForce(force.getOpposite())},Relation.prototype._swap=function(){this._canvas.History.begin(),this._swapCardinality(),this._swapIdentifying(),this._swapRequired(),this._canvas.History.commit()},Relation.prototype._swapCardinality=function(){var s=this._legs.source.getModel().getCardinality(),t=this._legs.target.getModel().getCardinality();this._canvas.History.begin(),this._legs.source.setCardinality(t),this._legs.target.setCardinality(s),this._canvas.History.commit()},Relation.prototype._swapIdentifying=function(){var s=this._legs.source.getModel().isIdentifying(),t=this._legs.target.getModel().isIdentifying();this._canvas.History.begin(),this._legs.source.toggleIdentifying(t),this._legs.target.toggleIdentifying(s),this._canvas.History.commit()},Relation.prototype._swapRequired=function(){var s=this._legs.source.getModel().isOptional(),t=this._legs.target.getModel().isOptional();this._canvas.History.begin(),this._legs.source.toggleOptional(t),this._legs.target.toggleOptional(s),this._canvas.History.commit()},Relation.prototype.showNames=function(){this._legs.source.showName(),this._legs.target.showName()},Relation.prototype.hideNames=function(){this._legs.source.hideName(),this._legs.target.hideName()},Relation.prototype.onEntityDrag=function(dx,dy){this._model.hasManualPoints()||this._model.resetAnchors(),this.isRecursive()||this.centerMiddlePoint(),this._legs.source.getModel().inXor&&this._sourceEntity.redrawXor(null,this._legs.source),this._legs.target.getModel().inXor&&this._targetEntity.redrawXor(null,this._legs.target);
},Relation.prototype.onXorUpdate=function(){this._model.hasManualPoints()||this._model.resetMiddlePoint(),this.redraw()},Relation.prototype.onEntityResize=function(){this._model.middleManual||this._model.resetMiddlePoint(),this.redraw()},Relation.prototype.onAnchorMove=function(){this._model.middleManual||this._model.resetMiddlePoint(),this.redraw()},Relation.prototype.onMouseMove=function(e,mouse){if(!this._canvas.inCorrectionMode)if(this._new){var target=mouse.getTarget();target instanceof ns.Control.Entity?(this._targetEntity=target,this._moveToEntity()):(this._targetEntity=null,this._moveToCursor(mouse.x,mouse.y))}else this._moveMiddle(mouse),this.redraw()},Relation.prototype.onMouseUp=function(e,mouse){this._new&&(this._new=!1,null==this._targetEntity?this._view.clear():this._setupEntities())},Relation.prototype.handleMenu=function(action,params){if(ns.Diagram.allowEdit)switch(action){case"swap":return this._swap(),void this.redrawType();case"swap-card":return this._swapCardinality(),void this.redrawType();case"swap-ident":return this._swapIdentifying(),void this.redrawType();case"swap-req":return this._swapRequired(),void this.redrawType();case"delete":return void this.clear()}switch(action){case"reset":this._model.resetMiddlePoint();break;case"straighten":this.straighten();break;case"toback":this._view.toBack();break;case"tofront":this._view.toFront()}this.redraw()},Relation.prototype.playback=function(action,from,to){switch(action){case"create":case"clear":to?this.undoClear():this.clear();break;case"middle":this._moveMiddle(to),this._model.middleManual=to.manual,this.redraw()}},Relation}(),DBSDM.Control=DBSDM.Control||{},DBSDM.Control.RelationLeg=function(){function RelationLeg(relationControl,canvas,model){this._relation=relationControl,this._canvas=relationControl.getCanvas(),this._entity=null,this._model=model,this._view=null,this.draw();var name=model.getName();name&&this._view.toggleName(),this._inXorCreation=!1}var ns=DBSDM,Enum=ns.Enums,EdgeOffset=10,ControlCreationOffset=10;return RelationLeg.prototype.setEntityControl=function(entityControl){this._entity=entityControl,this._view.onEntityAttached()},RelationLeg.prototype.getRelation=function(){return this._relation},RelationLeg.prototype.draw=function(){this._view=new ns.View.RelationLeg(this._canvas,this._model,this),this._view.draw()},RelationLeg.prototype.redraw=function(){this._view.updateAnchorPosition(),this._view.updatePoints()},RelationLeg.prototype.redrawType=function(){this._view.updateType(),this._view.updateAnchorType()},RelationLeg.prototype.getDom=function(){return this._view.getDom()},RelationLeg.prototype.getModel=function(){return this._model},RelationLeg.prototype.translateAnchor=function(x,y){var anchor=this._model.getAnchor();this._model.setAnchor(anchor.x+x,anchor.y+y,anchor.edge),this._model.inXor&&this._entity.redrawXor(null,this)},RelationLeg.prototype.translate=function(dx,dy){this.translateAnchor(dx,dy),this._model.translatePoints(dx,dy)},RelationLeg.prototype._moveAnchor=function(mouse){var initial=Object.assign({},this._model.getAnchor()),pos=this._entity.getEdgeCursorPosition(mouse.x,mouse.y);null!=pos&&(0!=(1&pos.edge)?pos.y=ns.Geometry.snap(pos.y,this._model.getPoint(1).y,null,ns.Consts.SnappingLimit):pos.x=ns.Geometry.snap(pos.x,this._model.getPoint(1).x,null,ns.Consts.SnappingLimit),this._model.setAnchor(pos.x,pos.y,pos.edge)),this._relation.onAnchorMove(),this._model.inXor&&this._entity.redrawXor(null,this),this._canvas.History.record(this,"anchor",initial,Object.assign({},this._model.getAnchor()))},RelationLeg.prototype.createControlPoint=function(P,index){var minDist,i,A,B,dist,points=this._model.getPoints();if(!index)for(index=1,minDist=-1,i=1;i<points.length;i++)A=points[i-1],B=points[i],ns.Geometry.pointIsInBox(P,A,B,ControlCreationOffset)&&(dist=ns.Geometry.pointToLineDistance(P,A,B),(minDist==-1||dist<minDist)&&(minDist=dist,index=i));return this._model.addPoint(index,P),this._view.buildControlPoint(index,P),this._view.updatePoints(),this._model.pointsManual=!0,this._canvas.History.record(this,"cp:"+this._model.getPointsCount(),null,{x:P.x,y:P.y,index:index}),index},RelationLeg.prototype._removeControlPoint=function(index){this._canvas.History.record(this,"cp:"+this._model.getPointsCount(),Object.assign({index:index},this._model.getPoint(index)),null,!1),this._model.removePoint(index),this._view.removeControlPoint(index-1),this._view.updatePoints()},RelationLeg.prototype._moveControlPoint=function(index,pos){var p=this._model.getPoint(index),prev=this._model.getPoint(index-1),next=this._model.getPoint(index+1),initial={x:p.x,y:p.y,index:index};p.x=ns.Geometry.snap(pos.x,prev.x,next.x,ns.Consts.SnappingLimit),p.y=ns.Geometry.snap(pos.y,prev.y,next.y,ns.Consts.SnappingLimit),this._relation.centerMiddlePoint(),this._canvas.History.record(this,"cp:"+this._model.getPointsCount(),initial,{x:p.x,y:p.y,index:index})},RelationLeg.prototype._initXor=function(){if(ns.Diagram.allowEdit){this._relation.getCanvas().Mouse.attachObject(this),this._view.select(),this._entity.markRelations(this,this._model.inXor),this._inXorCreation=!0;var that=this;ns.Diagram.cancelAction=function(){that.xor(null)}}},RelationLeg.prototype.xor=function(leg){if(this._inXorCreation&&(this._inXorCreation=!1,this._entity.unmarkRelations(),ns.Diagram.cancelAction=null,leg))return this==leg?(this._relation.getCanvas().ui.error("Same leg selected",ns.Consts.UIDefaultErrorDuration),void console.log("Same leg selected")):this._model.inXor&&leg._model.inXor?(this._relation.getCanvas().ui.error("Both relations are already in XOR",ns.Consts.UIDefaultErrorDuration),void console.log("Both relations are already in XOR")):this._entity!=leg._entity?(this._relation.getCanvas().ui.error("Relations have different parent",ns.Consts.UIDefaultErrorDuration),void console.log("Legs have different parent")):void(this._model.inXor?this._entity.xorWith(leg,this):this._entity.xorWith(this,leg))},RelationLeg.prototype._removeXor=function(){this._entity.removeXorLeg(this)},RelationLeg.prototype.mark=function(){this._view.mark()},RelationLeg.prototype.allow=function(){this._view.allow()},RelationLeg.prototype.clearMarks=function(){this._view.clearSelectionClasses()},RelationLeg.prototype._toggleIncorrect=function(){this._model.incorrect=!this._model.incorrect,this._model.incorrect?this._view.markIncorrect():this._view.markCorrect()},RelationLeg.prototype.showName=function(){this._view.showName()},RelationLeg.prototype.hideName=function(){this._view.hideName()},RelationLeg.prototype.toggleName=function(){this._view.toggleName()},RelationLeg.prototype.onEntityDrag=function(dx,dy){this._relation.isRecursive()?this._relation.translate(.5*dx,.5*dy):this.translateAnchor(dx,dy)},RelationLeg.prototype.onEntityResize=function(edges){var a=this._model.getAnchor();switch(a.edge){case Enum.Edge.LEFT:a.x=edges.left;break;case Enum.Edge.RIGHT:a.x=edges.right;break;case Enum.Edge.TOP:a.y=edges.top;break;case Enum.Edge.BOTTOM:a.y=edges.bottom}0!=(1&a.edge)?(a.y=Math.max(a.y,edges.top+EdgeOffset),a.y=Math.min(a.y,edges.bottom-EdgeOffset)):(a.x=Math.max(a.x,edges.left+EdgeOffset),a.x=Math.min(a.x,edges.right-EdgeOffset)),this._model.setAnchor(a.x,a.y,a.edge),this._model.inXor&&this._entity.redrawXor(null,this),this._relation.onEntityResize()},RelationLeg.prototype.onMouseDown=function(e,mouse){if(!this._canvas.inCorrectionMode){var params=mouse.getParams();params.action&&"line"==params.action&&(params.action="cp",params.index=this.createControlPoint({x:mouse.x,y:mouse.y}))}},RelationLeg.prototype.onMouseMove=function(e,mouse){if(!this._canvas.inCorrectionMode){var params=mouse.getParams();params.action&&("anchor"==params.action?this._moveAnchor(mouse):"cp"==params.action&&this._moveControlPoint(params.index,mouse))}},RelationLeg.prototype.onMouseUp=function(e,mouse){if(this._canvas.inCorrectionMode)return void this._toggleIncorrect();var leg=mouse.getTarget();leg instanceof ns.Control.RelationLeg?this.xor(leg):this.xor(null)},RelationLeg.prototype.setCardinality=function(cardinality){var initial=this._model.getCardinality();this._model.setCardinality(cardinality),this._canvas.History.record(this,"cardinality",initial,cardinality)},RelationLeg.prototype.toggleIdentifying=function(value){value="boolean"==typeof value?value:!this._model.isIdentifying(),this._model.setIdentifying(value),this._canvas.History.record(this,"identifying",!value,value)},RelationLeg.prototype.toggleOptional=function(value){value="boolean"==typeof value?value:!this._model.isOptional(),this._model.setOptional(value),this._canvas.History.record(this,"optional",!value,value)},RelationLeg.prototype.handleMenu=function(action,params){switch(action){case"cp-delete":if(params.index)return void this._removeControlPoint(params.index);break;case"name":return void this.toggleName()}if(ns.Diagram.allowEdit){switch(action){case"one":this.setCardinality(Enum.Cardinality.ONE);break;case"many":this.setCardinality(Enum.Cardinality.MANY);break;case"identifying":this.toggleIdentifying();break;case"required":this.toggleOptional();break;case"xor":this._initXor();break;case"remove-xor":this._removeXor()}this.redrawType()}},RelationLeg.prototype.getMenuState=function(){return{one:this._model.getCardinality()==Enum.Cardinality.ONE,many:this._model.getCardinality()==Enum.Cardinality.MANY,identifying:this._model.isIdentifying(),required:!this._model.isOptional(),name:null!=this._view._name,"remove-xor":this._model.inXor}},RelationLeg.prototype.playback=function(action,from,to){var list=action.split(":");switch(list[0]){case"cp":null==from?this.createControlPoint(to,to.index):null==to?this._removeControlPoint(from.index):this._moveControlPoint(to.index,to),this._relation.centerMiddlePoint();break;case"anchor":this._model.setAnchor(to.x,to.y,to.edge),this._relation.onAnchorMove();break;case"cardinality":this.setCardinality(to),this.redrawType();break;case"optional":this.toggleOptional(to),this.redrawType();break;case"identifying":this.toggleIdentifying(to),this.redrawType()}},RelationLeg}(),DBSDM.Model=DBSDM.Model||{},DBSDM.Model.Attribute=function(){function Attribute(name){this._name=name||"attribute",this._primary=!1,this._unique=!1,this._nullable=!1,this.incorrect=!1}return Attribute.prototype.getName=function(){return this._name},Attribute.prototype.setName=function(name){return this._name=name.trim().toLocaleLowerCase(),this},Attribute.prototype.isPrimary=function(){return this._primary},Attribute.prototype.setPrimary=function(bool){return"boolean"==typeof bool&&(this._primary=bool,bool&&(this._unique=!1)),this},Attribute.prototype.isUnique=function(bool){return this._unique},Attribute.prototype.setUnique=function(bool){return"boolean"==typeof bool&&(this._unique=bool,bool&&(this._primary=!1)),this},Attribute.prototype.isNullable=function(){return this._nullable},Attribute.prototype.setNullable=function(bool){return"boolean"==typeof bool&&(this._nullable=bool),this},Attribute.prototype.toString=function(){var atrs,str="";return str+=this._name,atrs=[],this._primary?atrs.push("PRIMARY KEY"):this._unique&&atrs.push("UNIQUE"),this._nullable?atrs.push("NULL"):atrs.push("NOT NULL"),0!=atrs.length&&(str+=": "+atrs.join(" ")),str},Attribute.prototype.getData=function(){this.setName(this._name);var data={name:this._name,primary:this._primary,unique:this._unique,nullable:this._nullable};return this.incorrect&&(data.incorrect=!0),data},Attribute}(),DBSDM.Model=DBSDM.Model||{},DBSDM.Model.AttributeList=function(){function AttributeList(){this._list=[]}var ns=DBSDM;return AttributeList.prototype.getList=function(){return this._list},AttributeList.prototype.add=function(attribute,position){void 0==position?this._list.push(attribute):this._list.splice(position,0,attribute)},AttributeList.prototype.remove=function(attribute){this._list.splice(this.getPosition(attribute),1)},AttributeList.prototype.getPosition=function(attribute){return this._list.findIndex(function(element,index,array){return element==attribute})},AttributeList.prototype.setPosition=function(attribute,position){this.remove(attribute),this.add(attribute,position)},AttributeList.prototype.getSize=function(){return this._list.length},AttributeList.prototype.toString=function(){var i,str="";for(i in this._list)str+=" "+this._list[i].toString()+"\n";return str},AttributeList.prototype.getExportData=function(){var i,list=Object.assign([],this._list),result=[];for(i=0;i<list.length;i++)result.push(list[i].getData());return result},AttributeList.prototype.import=function(data){var count,i,a,atr;if("object"==typeof data)for(count=data.length,i=0;i<count;i++){if(a=data[i],!a.name)return;atr=new ns.Model.Attribute(a.name).setPrimary(a.primary).setUnique(a.unique).setNullable(a.nullable),"boolean"==typeof a.incorrect&&(atr.incorrect=a.incorrect),this.add(atr)}},AttributeList}(),DBSDM.Model=DBSDM.Model||{},DBSDM.Model.CanvasObject=function(){function CanvasObject(){this._transform={x:0,y:0,width:1,height:1},this.incorrect=!1}return CanvasObject.prototype.setPosition=function(x,y){this._transform.x=null!=x?x:this._transform.x,this._transform.y=null!=y?y:this._transform.y},CanvasObject.prototype.translate=function(dx,dy){this._transform.x+=null!=dx?dx:0,this._transform.y+=null!=dy?dy:0},CanvasObject.prototype.setSize=function(w,h){this._transform.width=null!=w?w:this._transform.width,this._transform.height=null!=h?h:this._transform.height},CanvasObject.prototype.resize=function(dw,dh){this._transform.width+=null!=dw?dw:0,this._transform.height+=null!=dh?dh:0},CanvasObject.prototype.getTransform=function(){return this._transform},CanvasObject.prototype.getEdges=function(){var transform=Object.assign({},this._transform);return{top:transform.y,right:transform.x+transform.width,bottom:transform.y+transform.height,left:transform.x}},CanvasObject.prototype.getExportData=function(properties){var data={};return properties.saveTransform&&(data.transform=this._transform),this.incorrect&&(data.incorrect=!0),data},CanvasObject.prototype.import=function(data){data.transform&&(this.setPosition(data.transform.x,data.transform.y),this.setSize(data.transform.width,data.transform.height)),"boolean"==typeof data.incorrect&&(this.incorrect=data.incorrect)},CanvasObject}(),DBSDM.Model=DBSDM.Model||{},DBSDM.Model.Entity=function(){function Entity(name){Super.call(this),this._name=name&&"string"==typeof name?name:"Entity",this._attributes=new ns.Model.AttributeList,this._parent=null,this._children=[],this._relationLegs=[],this._xorList=[],name&&"object"==typeof name&&this.import(name)}var ns=DBSDM,Enum=ns.Enums,EdgeOffset=ns.Consts.EntityEdgePadding,Super=ns.Model.CanvasObject;return Entity.prototype=Object.create(Super.prototype),Entity.prototype.constructor=Entity,Entity.prototype.getName=function(){return this._name},Entity.prototype.setName=function(name){name=name.trim(),this._name=name[0].toLocaleUpperCase()+name.substr(1).toLocaleLowerCase()},Entity.prototype.setParent=function(parent){this._parent=parent},Entity.prototype.hasParent=function(){return null!=this._parent},Entity.prototype.addChild=function(child){this._children.push(child)},Entity.prototype.removeChild=function(child){for(var i=0;i<this._children.length;i++)if(child==this._children[i])return void this._children.splice(i,1)},Entity.prototype.getChildren=function(){return this._children},Entity.prototype.getAttributeList=function(){return this._attributes},Entity.prototype.addRelation=function(relationLeg){this._relationLegs.push(relationLeg),relationLeg.setEntity(this)},Entity.prototype.removeRelation=function(relationLeg){var i,index=null;for(i in this._relationLegs)if(this._relationLegs[i]==relationLeg){index=i;break}null!=index&&(this._relationLegs.splice(index,1),relationLeg.setEntity(null))},Entity.prototype.createXor=function(legA,legB){this._xorList.push([legA,legB]),legA.inXor=!0,legB.inXor=!0},Entity.prototype.addToXor=function(index,leg){this._xorList[index].push(leg),leg.inXor=!0},Entity.prototype.removeXor=function(index){for(var i=0;i<this._xorList[index].length;i++)this._xorList[index][i].inXor=!1;this._xorList.splice(index,1)},Entity.prototype.removeXorLeg=function(xorIndex,legIndex){this._xorList[xorIndex][legIndex].inXor=!1,this._xorList[xorIndex].splice(legIndex,1)},Entity.prototype.getXor=function(index){return this._xorList[index]},Entity.prototype.getXorHash=function(leg){for(var i=0;i<this._xorList.length;i++)if(this._xorList[i].indexOf(leg)!=-1)return this._xorList[i].map(function(leg){return leg.getRelation().getHash()}).sort().join("");return null},Entity.prototype.getEdges=function(){for(var parentTransform,edges=Super.prototype.getEdges.call(this),parent=this._parent;null!=parent;)parentTransform=parent.getTransform(),edges.right+=parentTransform.x,edges.left+=parentTransform.x,edges.top+=parentTransform.y,edges.bottom+=parentTransform.y,parent=parent._parent;return edges},Entity.prototype._pointsOnEdgeCmp=function(a,b){return a-b},Entity.prototype.getEdgePosition=function(edge){var i,anchor,edges,edgeStart,edgeEnd,ptsLen,bestPoint,maxDiff,diff,dist,points=[];for(i=0;i<this._relationLegs.length;i++)anchor=this._relationLegs[i].getAnchor(),anchor.edge==edge&&points.push(0==(1&edge)?anchor.x:anchor.y);for(points.sort(this._pointsOnEdgeCmp),edges=this.getEdges(),0==(1&edge)?(edgeStart=edges.left+EdgeOffset,edgeEnd=edges.right-EdgeOffset):(edgeStart=edges.top+EdgeOffset,edgeEnd=edges.bottom-EdgeOffset),points.unshift(edgeStart),ptsLen=points.push(edgeEnd),bestPoint=null,maxDiff=-1,i=1;i<ptsLen;i++)diff=.5*(points[i]-points[i-1]),diff>maxDiff&&(bestPoint=points[i]-diff,maxDiff=diff);switch(ptsLen>2&&maxDiff<ns.Consts.MinAnchorAnchorDistance&&(diff=points[1]-edgeStart,diff>maxDiff&&(bestPoint=edgeStart,maxDiff=diff),diff=edgeEnd-points[points.length-2],diff>maxDiff&&(bestPoint=edgeEnd,maxDiff=diff)),dist=maxDiff-ns.Consts.MinAnchorAnchorDistance,edge){case Enum.Edge.TOP:return{x:bestPoint,y:edges.top,edge:edge,dist:dist};break;case Enum.Edge.RIGHT:return{x:edges.right,y:bestPoint,edge:edge,dist:dist};break;case Enum.Edge.BOTTOM:return{x:bestPoint,y:edges.bottom,edge:edge,dist:dist};break;case Enum.Edge.LEFT:return{x:edges.left,y:bestPoint,edge:edge,dist:dist}}},Entity.prototype.toString=function(){var i,str="";str+="Entity "+this._name+"\n",str+="----------------------\n",str+=this._attributes.toString(),str+="----------------------\n";for(i in this._relationLegs)str+=this._relationLegs[i].getRelation().toString()+"\n";return str+="\n"},Entity.prototype.getExportData=function(properties){var data,i;for(this.setName(this._name),data=[{name:this._name,parent:null==this._parent?null:this._parent.getName(),attr:this._attributes.getExportData()}],i=0;i<this._children.length;i++)data=data.concat(this._children[i].getExportData(properties));return this.incorrect&&(data[0].incorrect=!0),properties.saveTransform&&(data[0].transform=this._transform),data},Entity.prototype.import=function(data){data.name&&(this._name=data.name),data.attr&&this._attributes.import(data.attr),Super.prototype.import.call(this,data)},Entity}(),DBSDM.Model=DBSDM.Model||{},DBSDM.Model.Note=function(){function Note(){Super.call(this),this.setSize(Consts.NoteDefaultWidth,Consts.NoteDefaultHeight),this._text="Click to edit"}var ns=DBSDM,Consts=ns.Consts,Super=ns.Model.CanvasObject;return Note.prototype=Object.create(Super.prototype),Note.prototype.constructor=Note,Note.prototype.getText=function(text){return this._text},Note.prototype.setText=function(text){this._text=text},Note.prototype.toString=function(){return"Note: "+this._text+"\n\n"},Note.prototype.getExportData=function(properties){var data={text:this._text};return Object.assign(data,Super.prototype.getExportData.call(this,properties)),data},Note.prototype.import=function(data){data.text&&this.setText(data.text),Super.prototype.import.call(this,data)},Note}(),DBSDM.Model=DBSDM.Model||{},DBSDM.Model.Relation=function(){function Relation(source,target){this._source=source,this._target=target,this._source.setRelation(this),this._target.setRelation(this),this.middleManual=!1}var ns=DBSDM,Enum=ns.Enums;return Relation.prototype.getSource=function(){return this._source},Relation.prototype.getTarget=function(){return this._target},Relation.prototype.hasManualPoints=function(){return this._source.pointsManual||this._target.pointsManual},Relation.prototype.getMiddlePoint=function(){return this._source.getPoint(-1)},Relation.prototype.setMiddlePointPosition=function(x,y){this._source.setPoint(-1,x,y),this._target.setPoint(-1,x,y)},Relation.prototype.translateMiddlePoint=function(dx,dy){var middle=this.getMiddlePoint(),x=middle.x+dx,y=middle.y+dy;this._source.setPoint(-1,x,y),this._target.setPoint(-1,x,y)},Relation.prototype.resetMiddlePoint=function(){var lft=this._source.getPoint(-2),rgt=this._target.getPoint(-2);this.setMiddlePointPosition((lft.x+rgt.x)/2,(lft.y+rgt.y)/2),this.middleManual=!1},Relation.prototype._addPoints=function(leg,entity,edge,recompute){var anchor=leg.getAnchor();return recompute||anchor.edge!=edge?entity.getEdgePosition(edge):anchor},Relation.prototype.resetAnchors=function(recompute,sourceEntity,targetEntity){var source,target,sourceEdges,targetEdges,i,minLen,bestSource,bestTarget,s,t,len;if(sourceEntity=sourceEntity||this._source.getEntity(),targetEntity=targetEntity||this._target.getEntity(),sourceEntity!=targetEntity){if(recompute=recompute||!1,source=[],target=[],sourceEdges=sourceEntity.getEdges(),targetEdges=targetEntity.getEdges(),sourceEdges.right<targetEdges.left?(source.push(this._addPoints(this._source,sourceEntity,Enum.Edge.RIGHT,recompute)),target.push(this._addPoints(this._target,targetEntity,Enum.Edge.LEFT,recompute))):sourceEdges.left>targetEdges.right&&(source.push(this._addPoints(this._source,sourceEntity,Enum.Edge.LEFT,recompute)),target.push(this._addPoints(this._target,targetEntity,Enum.Edge.RIGHT,recompute))),sourceEdges.bottom<targetEdges.top?(source.push(this._addPoints(this._source,sourceEntity,Enum.Edge.BOTTOM,recompute)),target.push(this._addPoints(this._target,targetEntity,Enum.Edge.TOP,recompute))):sourceEdges.top>targetEdges.bottom&&(source.push(this._addPoints(this._source,sourceEntity,Enum.Edge.TOP,recompute)),target.push(this._addPoints(this._target,targetEntity,Enum.Edge.BOTTOM,recompute))),0==source.length)for(i=0;i<4;i++)source.push(this._addPoints(this._source,sourceEntity,i,recompute)),target.push(this._addPoints(this._target,targetEntity,i,recompute));for(minLen=null,bestSource=null,bestTarget=null,s=0;s<source.length;s++)for(t=0;t<target.length;t++)len=ns.Geometry.pointToPointSquareDistance(source[s],target[t]),(null==minLen||len<minLen)&&(minLen=len,bestSource=source[s],bestTarget=target[t]);this._source.setAnchor(bestSource.x,bestSource.y,bestSource.edge),this._target.setAnchor(bestTarget.x,bestTarget.y,bestTarget.edge)}},Relation.prototype.straighten=function(recompute,sourceEntity,targetEntity){this._source.clearPoints(),this._target.clearPoints(),this.resetAnchors(recompute,sourceEntity,targetEntity),this.resetMiddlePoint()},Relation.prototype.toString=function(){var src=this._source.toString(),tgt=this._target.toString();return src.localeCompare(tgt)>0?tgt+" -> "+src:src+" -> "+tgt},Relation.prototype.getExportData=function(properties){var src=this._source.toString(),tgt=this._target.toString();return src.localeCompare(tgt)>0?[this._target.getExportData(properties),this._source.getExportData(properties)]:[this._source.getExportData(properties),this._target.getExportData(properties)]},Relation.prototype.getHash=function(){return[this._source.getHash(),this._target.getHash()].sort().join("")},Relation}(),DBSDM.Model=DBSDM.Model||{},DBSDM.Model.RelationLeg=function(){function RelationLeg(identifying,optional,cardinality){this._relation=null,this._entity=null,this._identifying=!1,this._optional=!1,this._cardinality=!1,this.setIdentifying(identifying).setOptional(optional).setCardinality(cardinality),this._name=null,this._anchor={x:0,y:0,edge:null},this._anchorOffset=0,this._points=[{x:0,y:0},{x:0,y:0}],this.pointsManual=!1,this.inXor=!1,this.incorrect=!1}var ns=DBSDM,Enum=ns.Enums;return RelationLeg.prototype.setRelation=function(relation){this._relation=relation},RelationLeg.prototype.getRelation=function(){return this._relation},RelationLeg.prototype.setEntity=function(entity){this._entity=entity},RelationLeg.prototype.getEntity=function(){return this._entity},RelationLeg.prototype.getName=function(){return this._name},RelationLeg.prototype.setName=function(name){return this._name=name.trim().toLocaleLowerCase()||null,this},RelationLeg.prototype.isIdentifying=function(){return this._identifying},RelationLeg.prototype.setIdentifying=function(bool){return"boolean"==typeof bool&&(this._identifying=bool),this},RelationLeg.prototype.isOptional=function(){return this._optional},RelationLeg.prototype.setOptional=function(bool){return"boolean"==typeof bool&&(this._optional=bool),this},RelationLeg.prototype.getCardinality=function(){return this._cardinality},RelationLeg.prototype.setCardinality=function(cardinality){return cardinality!=Enum.Cardinality.ONE&&cardinality!=Enum.Cardinality.MANY||(this._cardinality=cardinality),this},RelationLeg.prototype.getAnchor=function(){return this._anchor},RelationLeg.prototype.setAnchor=function(x,y,edge){this._anchor.x=x,this._anchor.y=y,this._anchor.edge=edge,this._updateFirstPoint()},RelationLeg.prototype.getAnchorOffset=function(){return this._anchorOffset},RelationLeg.prototype.setAnchorOffset=function(offset){this._anchorOffset=offset,this._updateFirstPoint()},RelationLeg.prototype._updateFirstPoint=function(){var offsetX,offsetY,edge=this._anchor.edge;null!=edge&&(offsetX=0,offsetY=0,0!=(1&edge)?offsetX=(edge-2)*this._anchorOffset:offsetY=(edge-1)*this._anchorOffset,this._points[0].x=this._anchor.x-offsetX,this._points[0].y=this._anchor.y+offsetY)},RelationLeg.prototype.getPointsCount=function(){return this._points.length},RelationLeg.prototype.addPoint=function(index,point){this._points.splice(index,0,point)},RelationLeg.prototype.setPoint=function(index,x,y){var key=index%this._points.length;key<0&&(key+=this._points.length),this._points[key].x=x,this._points[key].y=y},RelationLeg.prototype.getPoint=function(index){var key=index%this._points.length;return key<0&&(key+=this._points.length),this._points[key]},RelationLeg.prototype.getPointIndex=function(x,y){var i,p;for(i=0;i<this._points.length;i++)if(p=this._points[i],p.x==x&&p.y==y)return i},RelationLeg.prototype.removePoint=function(index){this._points.splice(index,1)},RelationLeg.prototype.clearPoints=function(){this._points.splice(1,this._points.length-2),this.pointsManual=!1},RelationLeg.prototype.getPoints=function(){return this._points},RelationLeg.prototype.getPointsCount=function(){return this._points.length},RelationLeg.prototype.translatePoints=function(dx,dy){for(var i=1;i<this._points.length-1;i++)this._points[i].x+=dx,this._points[i].y+=dy},RelationLeg.prototype.toString=function(){var str=this._entity.getName();return str+=" [",str+=this._identifying?"I":"i",str+=this._optional?"O":"o",str+="] ",str+=this._cardinality==Enum.Cardinality.ONE?"1":"N"},RelationLeg.prototype.getHash=function(){return ns.Hash.object([this._entity.getName(),this._identifying,this._optional,this._cardinality]).toString(16)},RelationLeg.prototype.getExportData=function(properties){var data={entity:this._entity.getName(),identifying:this._identifying,optional:this._optional,cardinality:this._cardinality,xor:this._entity.getXorHash(this)};return properties.saveRelationNames&&(data.name=this._name),properties.saveTransform&&(data.transform={anchor:this._anchor,points:this._points.slice(1),manual:this.pointsManual}),this.incorrect&&(data.incorrect=!0),data},RelationLeg.prototype.import=function(data){var pts,i;if(this.setIdentifying(data.identifying).setOptional(data.optional).setCardinality(data.cardinality),data.name&&this.setName(data.name),data.transform){for(this.setAnchor(data.transform.anchor.x,data.transform.anchor.y,data.transform.anchor.edge),pts=data.transform.points,this.setPoint(1,pts[pts.length-1].x,pts[pts.length-1].y),i=0;i<pts.length-1;i++)this.addPoint(i+1,pts[i]);this.pointsManual=data.transform.manual}return data.incorrect&&"boolean"==typeof data.incorrect&&(this.incorrect=data.incorrect),this},RelationLeg}(),DBSDM.View=DBSDM.View||{},DBSDM.View.Arc=function(){var self={},ns=DBSDM,Edge=ns.Enums.Edge,TOP=Edge.TOP,RIGHT=Edge.RIGHT,BOTTOM=Edge.BOTTOM,LEFT=Edge.LEFT;return self.getEdgeDistance=function(order){return ns.Consts.ArcEdgeDistance+order*ns.Consts.ArcArcDistance},self.build=function(edges,legs,edgeDist){function setDistMod(edge){switch(edge){case TOP:dx=0,dy=-edgeDist;break;case RIGHT:dx=edgeDist,dy=0;break;case BOTTOM:dx=0,dy=edgeDist;break;case LEFT:dx=-edgeDist,dy=0}}var points,dx,dy,g,path,edge,prev,skipped,i,pi,p,x,y;if(legs.length<1)return null;for(points=self._getArcPoints(legs),self._sortPoints(points),dx=0,dy=0,g=ns.Element.el("g",{pointerEvents:"none"}),path=new ns.Element.Path,edge=self._getStartingEdge(points,edges),prev=null,skipped=null,i=0;i<4;i++,edge=(edge+1)%4){if(0!=i){if(!points[edge]){skipped=edge;continue}if(null!=skipped){switch(setDistMod(skipped),edge){case TOP:x=edges.left,y=edges.bottom;break;case RIGHT:x=edges.left,y=edges.top;break;case BOTTOM:x=edges.right,y=edges.top;break;case LEFT:x=edges.right,y=edges.bottom}this._arcCorner(path,skipped,Math.round(x+dx-edges.left),Math.round(y+dy-edges.top))}}for(setDistMod(edge),pi=0;pi<points[edge].length;pi++)p=points[edge][pi],x=Math.round(p.x+dx-edges.left),y=Math.round(p.y+dy-edges.top),path.isEmpty()?this._arcStart(path,edge,x,y):0==pi&&this._arcCorner(path,edge,x,y),path.L(x,y),g.appendChild(ns.Element.el("circle",{cx:x,cy:y,r:2.5})),prev=edge}return this._arcEnd(path,prev,x,y),g.appendChild(path.path({stroke:"black",fill:"transparent"})),g},self._getArcPoints=function(legs){var i,anchor,edge,points={};for(i=0;i<legs.length;i++)anchor=legs[i].getAnchor(),edge=anchor.edge,points[edge]||(points[edge]=[]),points[edge].push(anchor);return points},self._pointsComparator=function(a,b){if(a.edge!=b.edge)return a.edge-b.edge;switch(a.edge){case TOP:return a.x-b.x;case RIGHT:return a.y-b.y;case BOTTOM:return b.x-a.x;case LEFT:return b.y-a.y}},self._sortPoints=function(points){for(var e in points)points.hasOwnProperty(e)&&points[e].sort(self._pointsComparator)},self._getStartingEdge=function(points,edges){var a,b,len,e;if(2==points.length&&(points[TOP]&&points[BOTTOM]||points[LEFT]&&points[RIGHT]))return points[TOP]?(len=points[TOP].length,a=edges.right-points[TOP][len-1].x,len=points[BOTTOM].length,b=points[BOTTOM][len-1].x-edges.left,a<b?TOP:BOTTOM):(len=points[RIGHT].length,a=edges.bottom-points[RIGHT][len-1].y,len=points[LEFT].length,b=points[LEFT][len-1].x-edges.top,a<b?RIGHT:LEFT);for(e=1;e<4;e++)if(!points[e-1]&&points[e])return e;return 0},self._arcCorner=function(path,edge,x,y){var a=ns.Consts.ArcSize;switch(edge){case TOP:path.V(y+a).c(0,-a,a,-a,a,-a);break;case RIGHT:path.H(x-a).c(a,0,a,a,a,a);break;case BOTTOM:path.V(y-a).c(0,a,-a,a,-a,a);break;case LEFT:path.H(x+a).c(-a,0,-a,-a,-a,-a)}},self._arcStart=function(path,edge,x,y){var a=ns.Consts.ArcSize,o=ns.Consts.ArcEndPointOffset;switch(edge){case TOP:path.M(x-a-o,y+a).c(0,-a,a,-a,a,-a);break;case RIGHT:path.M(x-a,y-a-o).c(a,0,a,a,a,a);break;case BOTTOM:path.M(x+a+o,y-a).c(0,a,-a,a,-a,a);break;case LEFT:path.M(x+a,y+a+o).c(-a,0,-a,-a,-a,-a)}},self._arcEnd=function(path,edge,x,y){var a=ns.Consts.ArcSize,o=ns.Consts.ArcEndPointOffset;switch(edge){case TOP:path.l(o,0).c(0,0,a,0,a,a);break;case RIGHT:path.l(0,o).c(0,0,0,a,-a,a);break;case BOTTOM:path.l(-o,0).c(0,0,-a,0,-a,-a);break;case LEFT:path.l(0,-o).c(0,0,0,-a,a,-a)}},self}(),DBSDM.View=DBSDM.View||{},DBSDM.View.Attribute=function(){function Attribute(model,control,canvas){this._model=model,this._control=control,this._canvas=canvas,this._svg=null,this._text=null,this._index=null,this._nullable=null,this._nameInput=null}var ns=DBSDM,height=18;return Attribute.prototype._getIndex=function(){
return this._model.isPrimary()?"#":this._model.isUnique()?"U":" "},Attribute.prototype._getNullable=function(){return this._model.isNullable()?"o":"*"},Attribute.prototype._getY=function(){return height*this._control.getPosition()},Attribute.prototype.getMinimalSize=function(){return{width:this._text.getBoundingClientRect().width,height:this._svg.getBoundingClientRect().height}},Attribute.prototype.create=function(control,parentDom){var model,that,mouse;this._svg=ns.Element.el("svg",{class:"attr",x:0,y:this._getY(),width:"100%",height:height}),ns.Diagram.allowEdit&&(this._svg.classList.add("draggable"),this._svg.classList.add("editable")),this._svg.appendChild(ns.Diagram.getSharedElement("Attr.Bg",{class:"attr-bg"})),this._text=this._svg.appendChild(ns.Element.text(5,"50%")),this._index=this._text.appendChild(ns.Element.el("tspan",{class:"attr-index"})),this._index.textContent=this._getIndex(),this._nullable=this._text.appendChild(ns.Element.el("tspan",{class:"attr-nullable",dx:"2",dy:"0"})),this._nullable.textContent=this._getNullable(),model=this._model,this._nameInput=new ns.View.EditableText(this._canvas,null,null,{dominantBaseline:"central",dx:"4"},function(){return model.getName()},function(value){that._control.setName(value)},"tspan"),that=this,this._nameInput.setNextHandler(function(prev){var dir=prev?-1:1;that._control.selectAt(that._control.getPosition()+dir,!0)}),this._nameInput.setEmptyHandler(function(){var position=that._control.getPosition();that._control.delete(),that._control.selectAt(position-1,!1)}),this._text.appendChild(this._nameInput.getTextDom()),this._svg.appendChild(this._text),parentDom.appendChild(this._svg),this._model.incorrect&&this.markIncorrect(),mouse=this._canvas.Mouse,this._svg.addEventListener("mousedown",function(e){that._canvas.isInMode("isa")||mouse.down(e,control)}),this._svg.addEventListener("contextmenu",function(e){ns.Menu.attach(control,"attribute")})},Attribute.prototype.showInput=function(){this._nameInput.showInput()},Attribute.prototype.redrawName=function(){this._nameInput.redraw()},Attribute.prototype.redrawIndex=function(){this._index.textContent=this._getIndex()},Attribute.prototype.redrawNullable=function(){this._nullable.textContent=this._getNullable()},Attribute.prototype.reposition=function(){ns.Element.attr(this._svg,{y:this._getY()})},Attribute.prototype.destroy=function(){this._svg.remove()},Attribute.prototype.getEdges=function(){return this._svg.getBoundingClientRect()},Attribute.prototype.dragStarted=function(){this._svg.classList.add("dragged")},Attribute.prototype.dragEnded=function(){this._svg.classList.remove("dragged")},Attribute.prototype.markIncorrect=function(){this._svg.classList.add("incorrect")},Attribute.prototype.markCorrect=function(){this._svg.classList.remove("incorrect")},Attribute}(),DBSDM.View=DBSDM.View||{},DBSDM.View.CanvasObject=function(){function CanvasObject(canvas,model,control){this._canvas=canvas,this._model=model,this._control=control,this._dom=null,this._controls=null}var ns=DBSDM;return CanvasObject.prototype.getDom=function(){return this._dom},CanvasObject.prototype.redraw=function(){ns.Element.attr(this._dom,this._model.getTransform())},CanvasObject.prototype.remove=function(){this._dom.remove()},CanvasObject.prototype.showControls=function(){this._controls=ns.Element.g(ns.Diagram.getSharedElement("Entity.ControlRectangle"),ns.Element.attr(ns.Diagram.getSharedElement("Entity.ControlPoint"),{class:"e-cp-nw",x:0,y:0}),ns.Element.attr(ns.Diagram.getSharedElement("Entity.ControlPoint"),{class:"e-cp-n",x:"50%",y:0}),ns.Element.attr(ns.Diagram.getSharedElement("Entity.ControlPoint"),{class:"e-cp-ne",x:"100%",y:0}),ns.Element.attr(ns.Diagram.getSharedElement("Entity.ControlPoint"),{class:"e-cp-e",x:"100%",y:"50%"}),ns.Element.attr(ns.Diagram.getSharedElement("Entity.ControlPoint"),{class:"e-cp-se",x:"100%",y:"100%"}),ns.Element.attr(ns.Diagram.getSharedElement("Entity.ControlPoint"),{class:"e-cp-s",x:"50%",y:"100%"}),ns.Element.attr(ns.Diagram.getSharedElement("Entity.ControlPoint"),{class:"e-cp-sw",x:0,y:"100%"}),ns.Element.attr(ns.Diagram.getSharedElement("Entity.ControlPoint"),{class:"e-cp-w",x:0,y:"50%"})),ns.Element.attr(this._controls,{class:"e-control"}),this._dom.appendChild(this._controls)},CanvasObject.prototype.hideControls=function(){this._controls.remove()},CanvasObject.prototype.toBack=function(){var first=this._dom.parentNode.querySelector(":first-child");first!=this._dom&&this._dom.parentNode.insertBefore(this._dom,first)},CanvasObject.prototype.toFront=function(){this._dom.parentNode.insertBefore(this._dom,null)},CanvasObject}(),DBSDM.View=DBSDM.View||{},DBSDM.View.EditableContent=function(){function EditableContent(canvas,properties,getHandler,setHandler){this._canvas=canvas,this._properties=Object.assign({dominantBaseline:"text-before-edge"},properties||{}),this._getHandler=getHandler,this._setHandler=setHandler,this._emptyHandler=null,this._text=null,this._input=null;var that=this;this._sizeHandler=function(){return that._text.getBoundingClientRect()},this._createSharedElements()}var ns=DBSDM;return EditableContent.shown=!1,EditableContent.prototype._setInputHandlers=function(){var that=this;ns.Diagram.allowEdit&&(this._text.classList.add("editable"),this._text.addEventListener("mousedown",function(e){that._canvas.inCorrectionMode||that._canvas.isInMode("isa")||that._canvas.Mouse.down(e,that)}))},EditableContent.prototype.getTextDom=function(){return this._text},EditableContent.prototype.setEmptyHandler=function(callback){this._emptyHandler=callback},EditableContent.prototype.setSizeHandler=function(callback){this._sizeHandler=callback},EditableContent.prototype._getValue=function(){return this._getHandler()||"Editable Text"},EditableContent.prototype._setValue=function(){this._setHandler(this._input.value),this._text.innerHTML=this._getValue()},EditableContent.prototype.redraw=function(){this._text.innerHTML="",this._text.innerHTML=this._getValue()},EditableContent.prototype.getFontSize=function(considerZoom){var fontSize,size;return considerZoom="boolean"!=typeof considerZoom||considerZoom,fontSize=window.getComputedStyle(this._text,null).getPropertyValue("font-size"),fontSize?(size=parseFloat(fontSize),considerZoom&&(size*=this._canvas.getZoomLevel()),size+"px"):null},EditableContent.prototype._placeInput=function(x,y,align){var cont=this._canvas._container.getBoundingClientRect();this._input.style.textAlign=align||"left",this._input.style.left=x-cont.left+"px",this._input.style.top=y-cont.top+"px"},EditableContent.prototype._hideInput=function(){this._input.style.display="none",this._text.style.visibility="visible",EditableContent.shown=!1},EditableContent.prototype.onMouseUp=function(e,mouse){this._canvas.inCorrectionMode||this.showInput()},EditableContent.prototype._confirm=function(){this._input.value=this._input.value.trim(),""==this._input.value?this._emptyHandler?(this._hideInput(),this._emptyHandler()):this._cancel():(this._setValue(),this._hideInput())},EditableContent.prototype._cancel=function(){this._input.onblur=null,this._input.value=this._getValue(),this._hideInput()},EditableContent}(),DBSDM.View=DBSDM.View||{},DBSDM.View.EditableLongText=function(){function EditableLongText(canvas,x,y,properties,getHandler,setHandler){this._canvas=canvas,this._properties=Object.assign({dominantBaseline:"text-before-edge"},properties||{});var that=this;this._getHandler=getHandler,this._setHandler=setHandler,this._emptyHandler=null,this._sizeHandler=function(){return that._text.getBoundingClientRect()},this._createSharedElements(),this._x=x,this._text=ns.Element.text(x,y,"",this._properties),this._input=this._canvas.getSharedHTMLElement("EditableLongText.Textarea"),this._hideInput(),this._text.appendChild(this._getTextSVG()),this._setInputHandlers.call(this)}var ns=DBSDM,Super=ns.View.EditableContent;return EditableLongText.prototype=Object.create(Super.prototype),EditableLongText.prototype.constructor=EditableLongText,EditableLongText.prototype._createSharedElements=function(){if(!this._canvas.hasSharedHTMLElement("EditableLongText.Textarea")){var input=document.createElement("textarea");input.className="editableSvgText",this._canvas.createSharedHTMLElement("EditableLongText.Textarea",input)}},EditableLongText.prototype._getTextSVG=function(){var div,fragment,that=this,dy=0,lineHeight=window.getComputedStyle(this._text,null).getPropertyValue("line-height");return lineHeight||(div=document.createElement("div"),div.classList.add("note-content-helper"),document.body.appendChild(div),lineHeight=window.getComputedStyle(div,null).getPropertyValue("line-height"),document.body.removeChild(div)),fragment=document.createDocumentFragment(),this._getValue().split("\n").forEach(function(line){var tspan=ns.Element.el("tspan",that._properties);tspan.innerHTML=line,ns.Element.attr(tspan,{x:that._x,dy:dy}),fragment.appendChild(tspan),dy=lineHeight}),fragment},EditableLongText.prototype._setValue=function(){this._setHandler(this._input.value),this._text.innerHTML="",this._text.appendChild(this._getTextSVG())},EditableLongText.prototype.redraw=function(){this._text.innerHTML="",this._text.appendChild(this._getTextSVG())},EditableLongText.prototype._setInputPosition=function(){var svgRect,x,y,sizeRect=this._sizeHandler();this._input.style.width=sizeRect.width+"px",this._input.style.height=sizeRect.height+"px",svgRect=this._text.getBoundingClientRect(),x=svgRect.left,y=svgRect.top-1,this._placeInput(x,y)},EditableLongText.prototype.showInput=function(){var fontSize,that;ns.Diagram.allowEdit&&(ns.Menu.hide(),fontSize=this.getFontSize(),fontSize&&(this._input.style.fontSize=this.getFontSize()),this._input.value=this._getValue(),this._setInputPosition(),this._input.style.display="block",this._input.focus(),this._text.style.visibility="hidden",Super.shown=!0,that=this,this._input.onkeyup=function(e){that._keyHandler(e)},this._input.onblur=function(e){that._confirm(e)})},EditableLongText.prototype._keyHandler=function(e){27==e.keyCode&&this._confirm()},EditableLongText}(),DBSDM.View=DBSDM.View||{},DBSDM.View.EditableText=function(){function EditableText(canvas,x,y,properties,getHandler,setHandler,el){Super.call(this,canvas,properties,getHandler,setHandler),this._leftOffset=0,this._nextHandler=null;var that=this;this._sizeHandler=function(){return that._span.innerHTML=that._input.value,{width:that._span.getBoundingClientRect().width}},"tspan"==el?(this._text=ns.Element.el("tspan",this._properties),this._text.innerHTML=this._getValue()):this._text=ns.Element.text(x,y,this._getValue(),this._properties),this._input=this._canvas.getSharedHTMLElement("EditableText.Input"),this._span=this._canvas.getSharedHTMLElement("EditableText.Span"),this._hideInput(),this._setInputHandlers.call(this)}var ns=DBSDM,Super=ns.View.EditableContent;return EditableText.prototype=Object.create(Super.prototype),EditableText.prototype.constructor=EditableText,EditableText.prototype._createSharedElements=function(){var input,span;this._canvas.hasSharedHTMLElement("EditableText.Input")||(input=document.createElement("input"),input.className="editableSvgText",input.type="text",this._canvas.createSharedHTMLElement("EditableText.Input",input),span=document.createElement("span"),span.style.position="absolute",span.style.left="-2000px",this._canvas.createSharedHTMLElement("EditableText.Span",span))},EditableText.prototype.setNextHandler=function(callback){this._nextHandler=callback},EditableText.prototype._setInputPosition=function(){var svgRect,align,x,y,sizeRect=this._sizeHandler();this._input.style.width=sizeRect.width+"px",svgRect=this._text.getBoundingClientRect(),align="left",x=svgRect.left+this._leftOffset,y=svgRect.top-1,this._properties.textAnchor&&"middle"==this._properties.textAnchor&&(align="center",x=Math.floor((svgRect.left+svgRect.right-sizeRect.width)/2+3)),this._placeInput(x,y,align)},EditableText.prototype.showInput=function(){var fontSize,value,that;ns.Diagram.allowEdit&&(ns.Menu.hide(),fontSize=this.getFontSize(),fontSize&&(this._input.style.fontSize=fontSize,this._span.style.fontSize=fontSize),value=this._getValue(),this._input.value=value,this._leftOffset=this._text.getBoundingClientRect().width-this._text.getComputedTextLength(),this._setInputPosition(),this._input.style.display="block",this._input.focus(),this._input.setSelectionRange(0,value.length),this._text.style.visibility="hidden",Super.shown=!0,that=this,this._input.onkeydown=function(e){that._keyDownHandler(e)},this._input.onkeyup=function(e){that._keyHandler(e)},this._input.onblur=function(e){that._confirm(e)})},EditableText.prototype._next=function(e){this._nextHandler&&(this._confirm(),this._nextHandler(e.shiftKey),e.preventDefault())},EditableText.prototype._keyDownHandler=function(e){9==e.keyCode&&this._next(e)},EditableText.prototype._keyHandler=function(e){13==e.keyCode?this._confirm():27==e.keyCode?this._cancel():9==e.keyCode||this._setInputPosition()},EditableText}(),DBSDM.View=DBSDM.View||{},DBSDM.View.Entity=function(){function Entity(canvas,model,control){Super.call(this,canvas,model,control),this._bg=null,this._name=null,this._attrContainer=null,this._xorNodes=[]}var ns=DBSDM,Super=ns.View.CanvasObject;return Entity.prototype=Object.create(Super.prototype),Entity.prototype.constructor=Entity,Entity.prototype.getAttrContainer=function(){return this._attrContainer},Entity.prototype.getMinimalSize=function(){var rect=this._name.getBoundingClientRect();return{width:rect.width+ns.Consts.EntityPadding,height:rect.height+ns.Consts.EntityPadding+ns.Consts.EntityExtraHeight}},Entity.prototype.setParent=function(parentDom){parentDom.appendChild(this._dom)},Entity.prototype.createEmpty=function(){var transform=this._model.getTransform();this._dom=ns.Element.el("svg",transform),this._dom.style.overflow="visible",this._bg=this._dom.appendChild(ns.Diagram.getSharedElement("Entity.Bg")),this._canvas.svg.appendChild(this._dom)},Entity.prototype.create=function(control){var mouse=this._canvas.Mouse,that=this,nameInput=new ns.View.EditableText(this._canvas,"50%",ns.Consts.EntityStrokeWidth,{class:"entity-name",textAnchor:"middle"},function(){return that._model.getName()},function(value){that._control.setName(value)});this._name=this._dom.appendChild(nameInput.getTextDom()),this._attrContainer=this._dom.appendChild(ns.Element.el("svg",{x:0,y:ns.Consts.EntityAttributesOffset})),this.defaultMark(),this._dom.addEventListener("mousedown",function(e){mouse.down(e,control)}),this._dom.addEventListener("mouseenter",function(e){mouse.enter(e,control)}),this._dom.addEventListener("mouseleave",function(e){mouse.leave(e)}),this._dom.addEventListener("contextmenu",function(e){DBSDM.Menu.attach(control,"entity")})},Entity.prototype.clearXor=function(index){this._xorNodes[index].remove(),this._xorNodes.splice(index,1)},Entity.prototype.drawXor=function(edges,index,edgeDistance){this._xorNodes[index]&&(this._xorNodes[index].remove(),this._xorNodes[index]=null);var arcNode=ns.View.Arc.build(edges,this._model.getXor(index),edgeDistance);this._dom.appendChild(arcNode),this._xorNodes[index]=arcNode},Entity.prototype.select=function(){ns.Element.attr(this._bg,{href:"#Entity.Bg.Selected"})},Entity.prototype.defaultMark=function(){this._model.incorrect?ns.Element.attr(this._bg,{href:"#Entity.Bg.Incorrect"}):ns.Element.attr(this._bg,{href:"#Entity.Bg"})},Entity}(),DBSDM.View=DBSDM.View||{},DBSDM.View.Note=function(){function Note(canvas,model,control){Super.call(this,canvas,model,control),this._bg=null,this._text=null}var ns=DBSDM,Super=ns.View.CanvasObject;return Note.prototype=Object.create(Super.prototype),Note.prototype.constructor=Note,Note.prototype.getMinimalSize=function(){var fontSize,rect,div=document.createElement("div");return div.classList.add("note-content-helper"),div.style.whiteSpace="pre",fontSize=this._text.getFontSize(!1),fontSize&&(div.style.fontSize=fontSize),div.textContent=this._model.getText(),document.body.appendChild(div),rect=div.getBoundingClientRect(),document.body.removeChild(div),{width:rect.width+2*ns.Consts.NotePadding,height:rect.height+2*ns.Consts.NotePadding}},Note.prototype.create=function(){var that,transform=this._model.getTransform();this._dom=ns.Element.el("svg",transform),this._dom.style.overflow="visible",this._bg=this._dom.appendChild(ns.Diagram.getSharedElement("Note.Bg")),this._canvas.svg.appendChild(this._dom),that=this,this._text=new ns.View.EditableLongText(this._canvas,ns.Consts.NotePadding,ns.Consts.NotePadding-2,{class:"note-content"},function(){return that._model.getText()},function(value){that._control.setText(value)}),this._text.setSizeHandler(function(){var rect=that._bg.getBoundingClientRect();return{width:rect.width-2*ns.Consts.NotePadding,height:rect.height-2*ns.Consts.NotePadding}}),this._dom.appendChild(this._text.getTextDom()),this.defaultMark(),this._dom.addEventListener("mousedown",function(e){that._canvas.Mouse.down(e,that._control)}),this._dom.addEventListener("contextmenu",function(){ns.Menu.attach(that._control,"note")})},Note.prototype.edit=function(){this._text.showInput()},Note.prototype.show=function(){this._dom.style.display="block"},Note.prototype.hide=function(){this._dom.style.display="none"},Note.prototype.defaultMark=function(){this._model.incorrect?ns.Element.attr(this._bg,{href:"#Note.Bg.Incorrect"}):ns.Element.attr(this._bg,{href:"#Note.Bg"})},Note}(),DBSDM.View=DBSDM.View||{},DBSDM.View.Relation=function(){function Relation(canvas,model,control){this._canvas=canvas,this._model=model,this._control=control,this._g=null,this._middle=null}var ns=DBSDM;return Relation.prototype.draw=function(sourceLegDomFragment,targetLegDomFragment){this._middle=ns.Diagram.getSharedElement("Relation.MiddlePoint",{class:"cp middle"}),this._g=ns.Element.g(sourceLegDomFragment,targetLegDomFragment,this._middle),this._g.classList.add("rel"),this._canvas.svg.appendChild(this._g);var that=this;this._middle.addEventListener("mousedown",function(e){that._canvas.Mouse.down(e,that._control)}),this._g.addEventListener("contextmenu",function(e){e.target.classList.contains("middle")&&ns.Menu.attach(that._control,"relationMiddle"),ns.Menu.attach(that._control,"relation")})},Relation.prototype.redraw=function(){ns.Element.attr(this._middle,this._model.getMiddlePoint())},Relation.prototype.toBack=function(){var first=this._g.parentNode.querySelector(":first-child");first!=this._g&&this._canvas.svg.insertBefore(this._g,first)},Relation.prototype.toFront=function(){this._canvas.svg.insertBefore(this._g,null)},Relation.prototype.clear=function(){this._g.remove(),this._g=null,this._middle=null},Relation}(),DBSDM.View=DBSDM.View||{},DBSDM.View.RelationLeg=function(){function RelationLeg(canvas,model,control){this._canvas=canvas,this._model=model,this._control=control,this._g=null,this._anchor=null,this._line=null,this._lineControl=null,this._name=null,this._cp=[],this._cardinality=null,this._identifying=null}var ns=DBSDM,Enum=ns.Enums;return RelationLeg.prototype.draw=function(){this._g=ns.Element.g(),this._buildLine(),this._buildAnchor(),this._g=ns.Element.g(this._lineControl,this._line,this._anchor),this.updatePoints(),this.updateType(),ns.Element.attr(this._g,{class:"leg"}),this._model.incorrect&&this.markIncorrect();var that=this;this._g.addEventListener("mousedown",function(e){var className=e.target.getAttribute("class"),params=null;"anchor"!=className&&"line"!=className||(params={action:className}),"cp"==className&&(params={action:className,index:1+that.getCpIndex(e.target)}),null!=params&&that._canvas.Mouse.down(e,that._control,params)}),this._g.addEventListener("contextmenu",function(e){var cls=e.target.getAttribute("class");"cp"==cls&&ns.Menu.attach(that._control,"relationCP",{index:1+that.getCpIndex(e.target)}),ns.Menu.attach(that._control,"relationLeg")})},RelationLeg.prototype.getDom=function(){return this._g},RelationLeg.prototype.onEntityAttached=function(){this._g.classList.add("attached")},RelationLeg.prototype._buildAnchor=function(){this._anchor=ns.Element.g(ns.Diagram.getSharedElement("Relation.AnchorControl",{class:"anchor"})),this.updateAnchorType(),this._model.setAnchorOffset(ns.Consts.DefaultAnchorOffset)},RelationLeg.prototype.updateAnchorType=function(){this._model.getCardinality()==Enum.Cardinality.MANY?null==this._cardinality&&(this._cardinality=this._anchor.appendChild(ns.Diagram.getSharedElement("Relation.AnchorMany"))):null!=this._cardinality&&(this._cardinality.remove(),this._cardinality=null),this._model.isIdentifying()?null==this._identifying&&(this._identifying=this._anchor.appendChild(ns.Diagram.getSharedElement("Relation.AnchorIdentifying"))):null!=this._identifying&&(this._identifying.remove(),this._identifying=null)},RelationLeg.prototype.updateAnchorPosition=function(){var anchor=this._model.getAnchor();ns.Element.transform(this._anchor,[anchor.x,anchor.y],[90*anchor.edge,0,0])},RelationLeg.prototype._buildLine=function(){this._line=ns.Element.el("polyline",{points:"0 0 0 0",fill:"none",stroke:"black",strokeWidth:1,strokeLinejoin:"round"}),this._lineControl=ns.Element.el("polyline",{points:"0 0 0 0",fill:"none",stroke:"none",strokeWidth:10,strokeLinecap:"butt",strokeLinejoin:"round",class:"line"})},RelationLeg.prototype._getPointsString=function(points){var a=this._model.getAnchor();return a.x+" "+a.y+" "+points.map(function(p){return[p.x,p.y]}).reduce(function(a,b){return a.concat(b)}).join(" ")},RelationLeg.prototype.updatePoints=function(){var i,points=this._model.getPoints(),pointsString=this._getPointsString(points);if(ns.Element.attr(this._line,{points:pointsString}),ns.Element.attr(this._lineControl,{points:pointsString}),this._cp.length!=points.length-2)for(this._clearControlPoints(),i=1;i<points.length-1;i++)this.buildControlPoint(i,points[i]);else for(i=1;i<points.length-1;i++)ns.Element.attr(this._cp[i-1],points[i]);this.updateNamePosition()},RelationLeg.prototype.updateType=function(){ns.Element.attr(this._line,{strokeDasharray:this._model.isOptional()?5:null})},RelationLeg.prototype.select=function(){this._g.classList.add("selected")},RelationLeg.prototype.allow=function(){this._g.classList.add("allowed")},RelationLeg.prototype.mark=function(){this._g.classList.add("marked")},RelationLeg.prototype.clearSelectionClasses=function(){this._g.classList.remove("selected"),this._g.classList.remove("allowed"),this._g.classList.remove("marked")},RelationLeg.prototype.markIncorrect=function(){this._g.classList.add("incorrect")},RelationLeg.prototype.markCorrect=function(){this._g.classList.remove("incorrect")},RelationLeg.prototype.buildControlPoint=function(index,p){var cp=this._g.appendChild(ns.Diagram.getSharedElement("Relation.CP",{x:p.x,y:p.y,class:"cp"}));this._cp.splice(index-1,0,cp)},RelationLeg.prototype.getCpIndex=function(cp){for(var index=0;index<this._cp.length;index++)if(this._cp[index]==cp)return index;return-1},RelationLeg.prototype.removeControlPoint=function(index){this._cp[index].remove(),this._cp.splice(index,1)},RelationLeg.prototype._clearControlPoints=function(){for(var i=0;i<this._cp.length;i++)this._cp[i].remove();this._cp=[]},RelationLeg.prototype.showName=function(){var model,name;this._name||(model=this._model,name=new ns.View.EditableText(this._canvas,0,0,{},function(){return model.getName()||"relation"},function(name){model.setName(name)}),this._name=name.getTextDom(),this.updateNamePosition(),this._g.appendChild(this._name))},RelationLeg.prototype.hideName=function(){this._name&&(this._name.remove(),this._name=null)},RelationLeg.prototype.toggleName=function(){this._name?this.hideName():this.showName()},RelationLeg.prototype.updateNamePosition=function(){var nameOffset,A,P,textAnchor,baseline,dx,dy;if(this._name){switch(nameOffset=10,A=this._model.getAnchor(),P=this._model.getPoint(0),textAnchor="start",baseline="text-after-edge",dx=0,dy=0,A.edge){case Enum.Edge.TOP:dy=-nameOffset;break;case Enum.Edge.RIGHT:dx=nameOffset;break;case Enum.Edge.BOTTOM:dy=nameOffset,baseline="text-before-edge";break;case Enum.Edge.LEFT:dx=-nameOffset,textAnchor="end"}ns.Element.attr(this._name,{x:P.x+dx,y:P.y+dy,dominantBaseline:baseline,textAnchor:textAnchor})}},RelationLeg}();